
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DEF CON CTF Qualifier 2013 OMGACM 3 Writeup - blue-lotus</title>
  <meta name="author" content="blue-lotus">

  
  <meta name="description" content="DEF CON CTF Qualifier 2013 OMGACM 3 Writeup Problem Description The remote host offers a racing game: % nc grandprix.shallweplayaga.me 2038
Use 'l' &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.blue-lotus.net//def-con-ctf-qualifier-2013-omgacm-3-writeup">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blue-lotus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="header-inner">
    <span class="first"><a href="/">blue-lotus</a></span>
    <span><a href="/about">about</a></span>
    <span class="last"><a href="/atom.xml" title="subscribe via RSS">rss</a></span>
  </div>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">DEF CON CTF Qualifier 2013 OMGACM 3 Writeup</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>DEF CON CTF Qualifier 2013 OMGACM 3 Writeup</p>

<h2 id="problem-description">Problem Description</h2>

<p>The remote host offers a racing game:</p>

<pre><code>% nc grandprix.shallweplayaga.me 2038
Use 'l' and 'r' to move. Don't crash.
Press return to start
</code></pre>

<p>We send a line feed to start the game and receive a 5×9 board:</p>

<pre><code>|-----|
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|  u  |
|-----|
</code></pre>

<p>We can send “l\n” to move left, “r\n” to move right, or “\n” to stand.<br />
At the end of the round, all obstacles fall. It is obvious that we need to avoide those obstacles.</p>

<h2 id="solution">Solution</h2>

<p>One way to view the problem is that we are forced to move forward one step each round.<br />
We can choose one of the three grids in front us. This is a special case of the dynamic pathfinding problem.</p>

<p>We can apply a breadth-first search to find a safe path from <code>u</code> to some cell in the first row.<br />
During the main loop of the search, we record for each cell how to reach it from the orignal grid.<br />
As decisions are made once per round, we can record only the first step for each path.</p>

<p>Moreover, we find that there will be a finishing line made up by a row of <code>=</code> not far beyond the 1000th round.<br />
It seems that <code>=</code> does not represent an obstacle.</p>

<pre><code>Round 1062 s
|-----|
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|=====|
|u    |
|-----|

Round 1063 s
|-----|
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|     |
|u====|
|-----|

Round 1064 s
You won this game. Push a key to play again

Round 1065 r
User won game
The key is: all our prix belong to you

Round 1066 r
</code></pre>

<p>So our criterion to check whether a grid represents an obstacle is: <code>c != ' ' &amp;amp;&amp;amp; c != 'u' &amp;amp;&amp;amp; c != '='</code>.</p>

<h2 id="programs">Programs</h2>

<p>Here is the program with BFS:</p>

<pre><code>#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
using namespace std;

#define FOR(i, a, b) for (int i = (a); i &amp;lt; (b); i++)
#define REP(i, n) FOR(i, 0, n)
#define SET(i, v) memset(i, v, sizeof i)

const int N = 11, M = 7;
char a[N][M+1], first[N][M], buf[4096];

bool isObstacle(char c)
{
  return c != &amp;#039; &amp;#039; &amp;amp;&amp;amp; c != &amp;#039;u&amp;#039; &amp;amp;&amp;amp; c != &amp;#039;=&amp;#039;;
}

bool cmp(int y, int yy)
{
  return abs(y-M/2) &amp;lt; abs(yy-M/2);
}

char work()
{
  int t = 0, x, y;
  REP(i, N) {
    REP(j, M + 1) {
      a[i][j] = buf[t++];
      if (a[i][j] == &amp;#039;u&amp;#039;)
        y = j;
    }
    a[i][M] = 0;
  }

  const char op[] = &amp;quot;lsr&amp;quot;;
  SET(first, 0);
  queue&amp;lt;pair &amp;gt; q;
  q.push(make_pair(9, y));
  while (! q.empty()) {
    x = q.front().first;
    y = q.front().second;
    q.pop();
    if (x == 1) break;
    int ys[] = {y-1, y, y+1};
    sort(ys, ys + 3, cmp);
    REP(i, 3) {
      int yy = ys[i];
      if (! first[x-1][yy] &amp;amp;&amp;amp; ! isObstacle(a[x-1][yy])) {
        first[x-1][yy] = x == 9 ? op[yy-y+1] : first[x][y];
        q.push(make_pair(x-1, yy));
      }
    }
  }

  const int cols[M-2] = {3,2,4,1,5};
  REP(i, M-2)
    if (first[1][cols[i]])
      return first[1][cols[i]];
  return 's';
}

int main()
{
  int sock_fd;
  struct hostent *host;
  struct sockaddr_in serv_addr = {};
  if ((host = gethostbyname("grandprix.shallweplayaga.me")) == NULL)
    return 1;
  if ((sock_fd = socket(AF_INET, SOCK_STREAM, 0)) == -1)
    return 1;
  serv_addr.sin_family = AF_INET;
  serv_addr.sin_port = htons(2038);
  serv_addr.sin_addr = *((struct in_addr *)host-&amp;gt;h_addr);
  if (connect(sock_fd, (struct sockaddr *)&amp;amp;serv_addr, sizeof serv_addr) == -1)
    return 1;

  // Press return to start
  read(sock_fd, buf, sizeof buf);
  puts(buf);
  write(sock_fd, "\n", 1);

  int round = 0, len;
  char choice[2] = {0, '\n'};
  while (len = read(sock_fd, buf, sizeof buf - 1), buf[len] = '', len &amp;gt; 40) {
    puts(buf);
    choice[0] = work();
    printf("Round %d %c\n", ++round, choice[0]);
    write(sock_fd, choice, sizeof choice);
  }
}
</code></pre>

<p>During the contest, we use another approach to solve this task by using a heuristic to find the “safest” column: the one with the least obstacles in the inverted triangle behind it.<br />
And then plan a path to move to the safest column while dodging obstacles nearby.</p>

<pre><code>#include 
#include 
#include 
#include 
#include 
#include 
#include 
#include 
#define MAXDATASIZE 4096
#include
#include
using namespace std;

const int N = 11;
const int M = 7;

char A[N][M+1];
char buf[MAXDATASIZE];

int x, y;

char path[N];

int c[M+1], s[M+1];

void cnt(int p, int y, int r)
{
    if (A[p][y] != ' ') return ;
    if (p == 1) {
        c[r]++;
        return ;
    }
    for (int j = -1; j  0 &amp;amp;&amp;amp; y + j &amp;lt; M-1) {
            cnt(p - 1, y + j, r);
        }
}

char op[4]=&amp;quot;lsr&amp;quot;;

bool dfs(int p, int y, int r)
{
    if ((A[p][y] != &amp;#039; &amp;#039;) &amp;amp;&amp;amp; (A[p][y] != &amp;#039;u&amp;#039;) &amp;amp;&amp;amp; (A[p][y] != &amp;#039;=&amp;#039;))
        return 0;
    if (p == 5) {
        return y == r;
    }
    for (int j = -1; j  0 &amp;amp;&amp;amp; y + j c[j];
}

void work()
{
    //puts(buf);
    memset(c, 0, sizeof c);
    int t = 0;
    for (int i = 0 ; i &amp;lt; N; i++) {
        for (int j = 0 ; j &amp;lt;= M; j++)
            A[i][j] = buf[t++];
        A[i][M] = 0;
        //puts(A[i]);
    }

    x = 9;
    for (int j = 1; j &amp;lt; 6; j++)
        if (A[9][j] == &amp;#039;u&amp;#039;) y = j;

    for (int i = 1; i &amp;lt; 6; i++) cnt(5, i, i);
    for (int i = 1; i &amp;lt; 6; i++)  s[i] = i;
    //sort(s + 1, s + 6, cmp);
    int k;
    for (int i = 1; i &amp;lt; 6; i++)
        for (int j = i+1; j  c[s[j]]) {
                k = s[i]; s[i] = s[j]; s[j] = k;
            }
    for (int i = 1; i h_addr);
    bzero(&amp;amp;(serv_addr.sin_zero),8);
    if (connect(sock_fd, (struct sockaddr *)&amp;amp;serv_addr,sizeof(struct sockaddr))==-1){
        perror("connect error");
        exit(1);
    }

    send(sock_fd,"\n",1,0);
    iLength=recv(sock_fd,buf,sizeof(buf),0);buf[iLength] = 0;
    puts(buf);
    iLength=recv(sock_fd,buf,sizeof(buf),0);buf[iLength] = 0;
    puts(buf);

    int cnt = 0;
    char r[3] = "";
    r[1]='\n';
    do {
        work();
        r[0] = path[9];
        printf("Round %d %s", ++cnt, r);
        send(sock_fd,r,2,0);
        iLength=recv(sock_fd,buf,sizeof(buf),0);
        buf[iLength]=0;
        puts(buf);
    } while (iLength &amp;gt; 40);
}
</code></pre>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">ray</span></span>

      








  


<time datetime="2013-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/uncategorized/'>Uncategorized</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/def-con-ctf-qualifier-2013-omgacm-2-writeup/" title="Previous Post: DEF CON CTF Qualifier 2013 OMGACM 2 Writeup">&laquo; DEF CON CTF Qualifier 2013 OMGACM 2 Writeup</a>
      
      
        <a class="basic-alignment right" href="/defcon-21-quals-annyong-writeup/" title="Next Post: Defcon 21 Quals annyong writeup">Defcon 21 Quals annyong writeup &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-weirdshark-writeup/">Codegate CTF Quals 2014 Weirdshark Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-weird_snus-writeup/">Codegate CTF Quals 2014 Weird_snus Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-web_proxy-writeup/">Codegate CTF Quals 2014 Web Proxy Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-clone-technique-writeup/">Codegate CTF Quals 2014 Clone Technique Writeup</a>
      </li>
    
      <li class="post">
        <a href="/2014-02-25-codegate-ctf-quals-2014-chrono-writeup/">Codegate CTF Quals 2014 Chrono Writeup</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - blue-lotus -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluelotus';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
